<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>记往开来</title>
  <meta name="author" content="Xiao Liu">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://xiaoliuai.github.io/index.html">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="记往开来" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://xiaoliuai.github.io/index.html">
  <meta property="og:title" content="记往开来">
  

  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">记往开来</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="q" value="site:xiaoliuai.github.io">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="记往开来" />
    
    <meta itemprop="url" content="http://xiaoliuai.github.io" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-12-10T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-12-10-summary-and-task-list.html" itemprop="url">Summary and Task List</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 架设网站和制作APP</a></li>
<li><a href="#sec-2">2. 数据</a></li>
<li><a href="#sec-3">3. 算法</a></li>
<li><a href="#sec-4">4. 最后</a></li>
</ul>
</div>
</div>
<p>
总体上,我在开发期间做了一下事项:
</p>
<ul class="org-ul">
<li>工作总览
</li>
<li>架设网站和尝试App蓝牙链接
</li>
<li>数据
</li>
<li>算法优化
</li>
</ul>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-12-10-summary-and-task-list.html"><span class="section-number-2">1</span> 架设网站和制作APP</a></h2>
<div class="outline-text-2" id="text-1">
<p>
这个简单网站上,我做了建立账户功能和食材推荐界面. 食材推荐界面仅仅用来测试卡路里算法和食材推荐算法.
</p>

<p>
总体来说功能非常简单,之所以消耗了很多时间,是因为本身工程技术底子不够好,同时还尝试了新技术Meteor.
在这个方面,个人认为之后的产品应当采用成熟技术,并且认真论证实际需求(比如实时这点就完全没必要).
很多公司有人专门做 <code>需求分析</code>,之后的团队肯定要有人做这个事情.当然,具体的开发工作是外包出去的.
</p>

<p>
APP也是需要外包的,但是同样需要很好的定义具体需求.
这里多提一点,就是硬件设备方面传递信号的降噪问题.个人觉得外包团队很可能没有相关经验,所以需要翘楚从硬件方面负责.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 数据</h2>
<div class="outline-text-2" id="text-2">
<p>
数据库方面,首先是数据建模,包括用户数据建模和食材等健康数据建模.
此处我有一个心得,那就是职能分块要清晰.
之前我拿到数据的时候,其实有很多冗余信息,导致软件工作混杂,开发效率低下.
比如说营养数据的单位,这个东西不应该是推荐算法要考虑的.
一个算法不应该考虑太多的事情,功能应该简单清晰,以便于模块化和工作分配.
如果需要转换单位,要么数据输入的时候就转化好,要么有别的的功能模块来做这个事情.如果要别的功能模块来做,那么对于工作量的分配就要考虑好.
</p>

<p>
数据管理包括数据采集,输入和清理;我本身只负责了一部分输入和清理工作. 数据输入方面,应当从内容上和格式上保证数据的质量(一致性,正确性).不然就会导致大量的时间耗费在数据清理上.数据采集的时候省功夫其实是把工作量转移到了开发者/数据管理者身上.在这里要把责任和分工细化明确.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 算法</h2>
<div class="outline-text-2" id="text-3">
<p>
首先总结一下开发算法时遇到的问题.
</p>
<ul class="org-ul">
<li>因为计算时间的限制,导致没有采用严格的规划算法,而近似算法在营养满足上不合要求
</li>
<li>因为对于算法问题的预估不足,导致中途多次大改.而在网站开发的语言架构下
做算法探索很低效(应该用Matlab或者R,或者说找个data scientist). <code>算法设计跟网站开发应当完全分开.</code>
</li>
<li>简单的规划算法会产生很多奇怪的极端解,手动加限制效果不好,编程也困难.
</li>
<li>还有很多因素没有考虑进去,比如说吸收率,食材相冲等等.这些实现本身需要数据(专家知识)的支持.
</li>
</ul>

<p>
在算法时间上,按照以前曾经讨论过的,应该划分区间,对于每种区间和情况 <code>离线预先计算食材配方</code>.之后可以直接使用,或者在其基础上微调.网站方面也应该对此进行接口设计.
</p>

<p>
专家知识方面, <code>食材相冲</code> 必须考虑.同时应该 <code>引入孕妇常用食谱</code>,在其基础上进行规划以避免极端情况.
&gt; 不过这样子似乎就不需要从食材本身进行组合了.
</p>

<p>
<code>吸收率</code> 方面,chinese DNI &lt;中国居民膳食营养素参考摄入量&gt;本身已经考虑了吸收率,建议参考.同时不建议过于频繁的更改数据/知识,一则输入费时(目前都是手工),二则没有那么多时间做太多实验比较算法和数据优劣.
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> 最后</h2>
<div class="outline-text-2" id="text-4">
<p>
除了要向外包团队学习以外,数据和算法是不能外包和很可能消耗大量时间的.在这方面希望慎重考虑.
</p>
</div>
</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-03-13T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-03-13-akka.html" itemprop="url">Akka</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Actors</a>
<ul>
<li><a href="#sec-1-1">1.1. Falt toleration</a></li>
<li><a href="#sec-1-2">1.2. Persistent Actor</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Cluster</a>
<ul>
<li><a href="#sec-2-1">2.1. Simple Cluster</a>
<ul>
<li><a href="#sec-2-1-1">2.1.1. Configuration</a></li>
<li><a href="#sec-2-1-2">2.1.2. Code</a></li>
<li><a href="#sec-2-1-3">2.1.3. Running</a></li>
</ul>
</li>
<li><a href="#sec-2-2">2.2. Dial-in example</a></li>
<li><a href="#sec-2-3">2.3. Cluster Aware Routers</a>
<ul>
<li><a href="#sec-2-3-1">2.3.1. <b>Group router</b></a></li>
<li><a href="#sec-2-3-2">2.3.2. <b>Pool router</b></a></li>
</ul>
</li>
<li><a href="#sec-2-4">2.4. Adaptive Load Balancing</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-03-13-akka.html"><span class="section-number-2">1</span> Actors</a></h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">import</span> akka.<span style="color: #268bd2;">actor</span>.{ ActorRef, ActorSystem, Props, Actor, Inbox }&#57344;&#57345;&#57345;
<span style="color: #859900;">import</span> scala.concurrent.duration.<span style="color: #268bd2;">_</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Three messages, one is object, two are case classes</span>&#57344;&#57345;&#57345;
<span style="color: #859900;">case</span> object Greet&#57344;&#57345;&#57345;
<span style="color: #859900;">case</span> <span style="color: #859900;">class</span> WhoToGreet(who: String)&#57344;&#57345;&#57345;
<span style="color: #859900;">case</span> <span style="color: #859900;">class</span> Greeting(message: String)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #859900;">class</span> Greeter <span style="color: #859900;">extends</span> <span style="color: #268bd2;">Actor</span> {&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">var</span> <span style="color: #6c71c4;">greeting</span> = <span style="color: #2aa198;">""</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  def receive = {&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> WhoToGreet(who) =&gt; greeting = s<span style="color: #2aa198;">"hello, $who"</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> Greet           =&gt; sender <span style="color: #268bd2;">!</span> Greeting(greeting)&#57344;&#57345;&#57345;
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Send the current greeting back to the sender</span>&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #268bd2;">object</span> <span style="color: #6c71c4;">HelloAkkaScala</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">App</span> {&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Create the 'helloakka' actor system</span>&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">system</span> = ActorSystem(<span style="color: #2aa198;">"helloakka"</span>)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Create the 'greeter' actor</span>&#57344;&#57345;&#57345;
  val greeter = system.actorOf(<span style="color: #268bd2;">Props</span>[Greeter], <span style="color: #2aa198;">"greeter"</span>)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Create an "actor-in-a-box"</span>&#57344;&#57345;&#57345;
  val inbox = Inbox.create(system)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Tell the 'greeter' to change its 'greeting' message</span>&#57344;&#57345;&#57345;
  greeter.tell(WhoToGreet(<span style="color: #2aa198;">"akka"</span>), ActorRef.noSender)&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Ask the 'greeter for the latest 'greeting'</span>&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Reply should go to the "actor-in-a-box"</span>&#57344;&#57345;&#57345;
  inbox.send(greeter, Greet)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Wait 5 seconds for the reply with the 'greeting' message</span>&#57344;&#57345;&#57345;
  val Greeting(message1) = inbox.receive(5.seconds)&#57344;&#57345;&#57345;
  println(s<span style="color: #2aa198;">"Greeting: $message1"</span>)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Change the greeting and ask for it again</span>&#57344;&#57345;&#57345;
  greeter.tell(WhoToGreet(<span style="color: #2aa198;">"typesafe"</span>), ActorRef.noSender)&#57344;&#57345;&#57345;
  inbox.send(greeter, Greet)&#57344;&#57345;&#57345;
  val Greeting(message2) = inbox.receive(5.seconds)&#57344;&#57345;&#57345;
  println(s<span style="color: #2aa198;">"Greeting: $message2"</span>)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  val greetPrinter = system.actorOf(<span style="color: #268bd2;">Props</span>[GreetPrinter])&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">after zero seconds, send a Greet message every second to the greeter with a sender of the greetPrinter</span>&#57344;&#57345;
  system.scheduler.schedule(0.seconds, 1.second, greeter, Greet)(system.dispatcher, greetPrinter)&#57344;&#57345;
&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">prints a greeting</span>&#57344;&#57345;&#57345;
<span style="color: #859900;">class</span> <span style="color: #268bd2;">GreetPrinter</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">Actor</span> {&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">def</span> <span style="color: #6c71c4;">receive</span> = {&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> Greeting(message) =&gt; println(message)&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>

<ul class="org-ul">
<li>Sending messages
<ol class="org-ol">
<li><code>actor ! message</code> or <code>actor.tell(message, sender)</code>.
</li>
<li><code>inbox.send(sender, message)</code>
</li>
<li><code>system.scheduler.schedule(initDelay, interval, receiver,
        message)(executor, sender)</code>
</li>
<li><code>actor ? message</code>, it means &#8220;ask&#8221;, which resturns a <code>Future</code>
representing a possible reply. When you implement ask
function, you have to catch the exception and send a Failure
to the sender
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">try</span> {&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">result</span> = operation()&#57344;&#57345;&#57345;
  sender() <span style="color: #268bd2;">!</span> result&#57344;&#57345;&#57345;
} <span style="color: #859900;">catch</span> {&#57344;&#57345;&#57345;
  <span style="color: #859900;">case</span> e: Exception =&gt;&#57344;&#57345;&#57345;
    sender() <span style="color: #268bd2;">!</span> <span style="color: #268bd2;">akka</span>.<span style="color: #268bd2;">actor</span>.<span style="color: #268bd2;">Status</span>.Failure(e)&#57344;&#57345;&#57345;
    <span style="color: #859900;">throw</span> e&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
<p>
You can set a timeout period for the <code>Future</code> by implicit
value <code>implicit val timeout = Timeout(5 seconds)</code> or using
curry function <code>myActor.ask(msg)(5 seconds)</code>.
</p>
</li>
</ol>
</li>
<li>Receiving messages
<ol class="org-ol">
<li><code>receive</code> defined method in actor will be called when message
comes. <b>Attention:</b>, the <code>sender()</code> method returns the current
sender when the method is called, <b>DO NOT</b> use this function
in callbacks since the sender method may returns wrong sender
(deadletter in many cases) when the callback is actually
invoked.
</li>
<li><code>inbox.receive</code>
</li>
<li>Set timeout period for receiving method,
<code>context.setReceiveTimeout(30 milliseconds)</code>. Then you can
catch this event by receiving message <code>case ReceiveTimeout</code>.
</li>
</ol>
</li>
<li>Forward message
<code>target forward message</code>, it will keep the sender unchanged. A
send msg to B, B forward msg to C, the sender for C is still A
instead of B
</li>
<li>Stop actor
<code>akka.actor.PoisonPill</code> message will stop the
actor. <code>gracefulStop</code> is useful to wait for termination or
compose ordered termination of several actors. It is a pattern,
not precoded, it sends a user defined message to the actor and
returns a <code>Future</code>, you can <code>Await</code> this future for a duration.

<p>
<code>actor ! Kill</code> will also stop this actor, but it causes the actor
to throw a <code>ActorKilledException</code>. This actor will suspend and
like the supervisor to decide how to handle the failure.
</p>
</li>
<li>Become/Unbecome
<code>context.become</code> method in Actor can setting the receive
function, hence the behavior of Actor is changed. <code>unbecome</code> lets
the actor returns to previews behavior.

<p>
You can use <code>stash</code> and <code>unstash</code> to save mails into a queue in
one behavior and get them back in another behavior. Of course,
you have to mix the trait <code>Stash</code> to be able to use it.
</p>
</li>
<li>Extend actor and intialization patterns
Use <code>PartialFunction#orElse</code> to chain the <code>receive</code> function of
the extended actor.

<p>
Three init patterns
</p>
<ol class="org-ol">
<li>constructor
</li>
<li>preStart
</li>
<li>Message
</li>
</ol>
</li>
</ul>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Falt toleration</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Example code from document.
</p>
<ol class="org-ol">
<li><code>Counter</code>, increment and save count to storage, return current
count number
</li>
<li><code>Storage</code>, simulate database, store (String, Long) pairs.
</li>
<li><code>CounterService</code>, override supervisorStrategy by
<code>OneForOneStrategy</code>
<div class="org-src-container">

<pre class="src src-java">override <span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">supervisorStrategy</span> = OneForOneStrategy(maxNrOfRetries = 3,&#57344;&#57345;
  withinTimeRange = 5.seconds) {&#57344;&#57345;&#57345;
  <span style="color: #859900;">case</span> _: <span style="color: #268bd2;">Storage</span>.StorageException =&gt; Restart&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>

<p>
init with actor refererences to the wrapper (watcher) of
storage, tell counter (when initialized?) to use the storage.
</p>

<p>
forward message (increment, getCurrentCount) to counter if it
exists; save <code>sender-&gt;msg</code> pair to log if counter is not
available.
</p>

<p>
if storage is terminated, tell counter that storage is not
available, schedule task to initStorage again (reconnect).
</p>
</li>
<li><code>Worker</code>, stop when receiving message from CounterService. init
<code>CounterService</code> actor.
</li>
<li><code>Listener</code>, shutdown the system while timeout. Listen
<code>Progress</code>, which is a case class of <code>Worker</code>.
</li>
<li>App object init worker and listener. Tell worker to assign the
listener, which will schedule task to use the <code>CounterService</code>
to increment count and pipe the message to listener.
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Persistent Actor</h3>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Cluster</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Simple Cluster</h3>
<div class="outline-text-3" id="text-2-1">
</div><div id="outline-container-sec-2-1-1" class="outline-4">
<h4 id="sec-2-1-1"><span class="section-number-4">2.1.1</span> Configuration</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
To run cluster, you have to first creat a configuration file that
specify the URI, actors, etc.
</p>
<pre class="example">
akka {
  actor {
    provider = "akka.cluster.ClusterActorRefProvider"
  }
  remote {
    log-remote-lifecycle-events = off
    netty.tcp {
      hostname = "127.0.0.1"
      port = 0
    }
  }

  cluster {
    seed-nodes = [
      "akka.tcp://ClusterSystem@127.0.0.1:2551",
      "akka.tcp://ClusterSystem@127.0.0.1:2552"]

    auto-down-unreachable-after = 10s
  }
}
</pre>
</div>
</div>

<div id="outline-container-sec-2-1-2" class="outline-4">
<h4 id="sec-2-1-2"><span class="section-number-4">2.1.2</span> Code</h4>
<div class="outline-text-4" id="text-2-1-2">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">package</span> sample.cluster.<span style="color: #268bd2;">simple</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">com</span>.<span style="color: #268bd2;">typesafe</span>.<span style="color: #268bd2;">config</span>.<span style="color: #268bd2;">ConfigFactory</span>&#57344;&#57345;&#57345;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">akka</span>.<span style="color: #268bd2;">actor</span>.<span style="color: #268bd2;">ActorSystem</span>&#57344;&#57345;&#57345;
<span style="color: #859900;">import</span> <span style="color: #268bd2;">akka</span>.<span style="color: #268bd2;">actor</span>.<span style="color: #268bd2;">Props</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #268bd2;">object</span> <span style="color: #6c71c4;">SimpleClusterApp</span> {&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">def</span> <span style="color: #6c71c4;">main</span>(args: Array[String]): Unit = {&#57344;&#57345;&#57345;
    <span style="color: #859900;">if</span> (args.isEmpty)&#57344;&#57345;&#57345;
      startup(Seq(<span style="color: #2aa198;">"2551"</span>, <span style="color: #2aa198;">"2552"</span>, <span style="color: #2aa198;">"0"</span>))&#57344;&#57345;&#57345;
    <span style="color: #859900;">else</span>&#57344;&#57345;&#57345;
      startup(args)&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">def</span> <span style="color: #6c71c4;">startup</span>(ports: Seq[String]): Unit = {&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">ports</span> <span style="color: #6c71c4;">foreach</span> { port =&gt;&#57344;&#57345;&#57345;
      <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Override the configuration of the port</span>&#57344;&#57345;&#57345;
      val config = ConfigFactory.parseString(<span style="color: #2aa198;">"akka.remote.netty.tcp.port="</span> + port).&#57344;&#57345;
        withFallback(ConfigFactory.load())&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
      <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Create an Akka system</span>&#57344;&#57345;&#57345;
      val system = ActorSystem(<span style="color: #2aa198;">"ClusterSystem"</span>, config)&#57344;&#57345;&#57345;
      <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">One system on one port?</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
      <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Create an actor that handles cluster domain events</span>&#57344;&#57345;&#57345;
      system.actorOf(<span style="color: #268bd2;">Props</span>[SimpleClusterListener], name = <span style="color: #2aa198;">"clusterListener"</span>)&#57344;&#57345;
    }&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #859900;">class</span> <span style="color: #268bd2;">SimpleClusterListener</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">Actor</span> with ActorLogging {&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">cluster</span> = Cluster(context.system)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">subscribe to cluster changes, re-subscribe when restart</span>&#57344;&#57345;&#57345;
  override def preStart(): Unit = {&#57344;&#57345;&#57345;
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">#subscribe</span>&#57344;&#57345;&#57345;
    cluster.subscribe(self, initialStateMode = InitialStateAsEvents,&#57344;&#57345;&#57345;
      classOf[MemberEvent], classOf[UnreachableMember])&#57344;&#57345;&#57345;
    <span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">#subscribe</span>&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
  override <span style="color: #268bd2;">def</span> <span style="color: #b58900;">postStop</span>(): Unit = cluster.unsubscribe(self)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  def receive = {&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> MemberUp(member) =&gt;&#57344;&#57345;&#57345;
      log.info(<span style="color: #2aa198;">"Member is Up: {}"</span>, member.address)&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> UnreachableMember(member) =&gt;&#57344;&#57345;&#57345;
      log.info(<span style="color: #2aa198;">"Member detected as unreachable: {}"</span>, member)&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> MemberRemoved(member, previousStatus) =&gt;&#57344;&#57345;&#57345;
      log.info(<span style="color: #2aa198;">"Member is Removed: {} after {}"</span>,&#57344;&#57345;&#57345;
        member.address, previousStatus)&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> _: MemberEvent =&gt; <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">ignore</span>&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-1-3" class="outline-4">
<h4 id="sec-2-1-3"><span class="section-number-4">2.1.3</span> Running</h4>
<div class="outline-text-4" id="text-2-1-3">
<p>
Log when starting the second seed node:
[info] [INFO] [03/10/2015 23:57:27.799]
[ClusterSystem-akka.actor.default-dispatcher-14]
[Cluster(akka://ClusterSystem)] Cluster Node
[akka.tcp://ClusterSystem@127.0.0.1:2551] - Node
[akka.tcp://ClusterSystem@127.0.0.1:2552] is JOINING, roles []
</p>

<p>
This code defines a cluster (集群), each node runs as dependennt
processes (different JVMs) since they all run on my local
machine. A cluster is indentified by <code>akka://CllusterSystem</code>,
while each node is indentified by IP address and port number. The
IP address seems like to be defined by application.config.
</p>

<ul class="org-ul">
<li><b>seed nodes</b> are configured contact points for initial,
automatic, join of the cluster. Hence, the <code>seed-nodes</code> figure
out where to join the cluster to current node. The seed nodes can
also be configured by command line options when starting the JVM
using the following syntax:
<div class="org-src-container">

<pre class="src src-bash">-Dakka.cluster.seed-nodes.0=akka.tcp://ClusterSystem@host1:2552
-Dakka.cluster.seed-nodes.1=akka.tcp://ClusterSystem@host1:2552
</pre>
</div>
<p>
Starting seed notes can be async and not all the seed nodes are
necessary to run. But the first node must be started when
starting a cluster.
</p>

<p>
It is also possible to join the cluster manually via <a href="http://doc.akka.io/docs/akka/2.3.9/scala/cluster-usage.html#cluster-jmx-scala"><i>JMX</i></a> or
<a href="http://doc.akka.io/docs/akka/2.3.9/scala/cluster-usage.html#cluster-command-line-scala"><i>Command Line Management</i></a> or via programatic method with
<code>Cluster.get(system).join(address)</code> or
<code>Cluster(system).joinSeedNodes</code>.
</p>
</li>
<li><code>hostname</code> in <code>remote</code> in configuration specify the IP of
current node. <b>Question:</b> /what if I specify the IP to another
machine? The application should be deploy to another machine
before running? What protocole does it uses?/
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Dial-in example</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Frontend-backend pattern (not those in Group router):
</p>
<ol class="org-ol">
<li>Backed subscribes to the cluster service to register new
frontend
</li>
<li>Frontend watch the backend and define the <code>receive</code> method for
the case of <code>Terminated(a)</code>.
</li>
<li>Frontend redirect received jobs to backend.
</li>
<li>Roles of node is defined in the configuration property named
<code>akka.cluster.roles</code> or in start script as a system property
or environment variable.
</li>
</ol>

<p>
Number of members restriction:
<code>akka.cluster.min-nr-of-members = 3</code>, the leader will not
change the status of nodes to &#8216;Up&#8217; until this number of
members reached. Finer configuration:
</p>
<p>
#+beign_src yaml
akka.cluster.role {
  frontend.min-nr-of-members = 1
  backend.min-nr-of-members = 2
}
</p>
<p>
#+end_src
Define callback to be invoked when the current member status is
changed to &#8216;Up&#8217;
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">Cluster</span>(<span style="color: #268bd2;">system</span>) registerOnMemberUp {&#57344;&#57345;&#57345;
  system.actorOf(Props(classOf[FactorialFrontend], upToN, <span style="color: #268bd2;">true</span>),&#57344;&#57345;&#57345;
    name = <span style="color: #2aa198;">"factorialFrontend"</span>)&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Cluster Aware Routers</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Router is one that receive and send tasks to actors, while the
ref to actors are called routees.
</p>
</div>

<div id="outline-container-sec-2-3-1" class="outline-4">
<h4 id="sec-2-3-1"><span class="section-number-4">2.3.1</span> <b>Group router</b></h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
在示例代码中,每一个node上面都有一个StatsService,和一个
StatsWorker. StatsService里面包含了指向StatsWorker的router并且负
责接受和转发任务. 每次Client将一个任务传给Cluster时,Cluster中某
个一node上的StatsService会接收并分发任务,因为分发任务是依靠
router来实现的,所以任务会被分发到不同node上的StatsWorker上去.这
个例子中,每个node上的Service和Worker都是显式创建的.
</p>

<p>
<b>Group example: Server side</b>
</p>
<div class="org-src-container">

<pre class="src src-yaml">akka.actor.deployment {&#57344;&#57345;&#57345;
  /statsService/workerRouter {&#57344;&#57345;&#57345;
      router = consistent-hashing-group&#57344;&#57345;&#57345;
      // specify the router, you have also other options like round-robin-pool&#57344;&#57345;
      nr-of-instances = 100&#57344;&#57345;&#57345;
      routees.paths = [<span style="color: #2aa198;">"/user/statsWorker"</span>]&#57344;&#57345;&#57345;
      cluster {&#57344;&#57345;&#57345;
        enabled = on&#57344;&#57345;&#57345;
        allow-local-routees = on&#57344;&#57345;&#57345;
        use-role = compute&#57344;&#57345;&#57345;
      }&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
<p>
With this configuration, relative actor paths defined in
<code>routees.paths</code> are used for selecting actors to send the message
by the router.
在创建System的时候将这个配置文件包含到配置中去, 然后在这个system
下面任意地方用 <code>actorOf(FromConfig.props(Props[YourClass]))</code> 来
得到router actor. 发送任务时将任务发给router actor,它会自动转发
给cluster中的注册在 &#8220;user&#8221; 下面的注册名为 &#8220;statsWorker&#8221; 的actor
(不一定是StatsWorker,你可以随意将不同类型的Actor注册在这个名字下
面). 更多的配置,查看<a href="http://doc.akka.io/docs/akka/snapshot/scala/routing.html">routing</a>.
</p>

<p>
下面的代码是用编程的方式实现配置文件里的配置.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">workerRouter</span> = context.actorOf(&#57344;&#57345;&#57345;
    ClusterRouterGroup(ConsistentHashingGroup(Nil), ClusterRouterGroupSettings(&#57344;&#57345;
      totalInstances = 100, routeesPaths = List(<span style="color: #2aa198;">"/user/statsWorker"</span>),&#57344;&#57345;&#57345;
      allowLocalRoutees = <span style="color: #268bd2;">true</span>, useRole = Some(<span style="color: #2aa198;">"compute"</span>))).props(),&#57344;&#57345;&#57345;
    name = <span style="color: #2aa198;">"workerRouter2"</span>)&#57344;&#57345;&#57345;
</pre>
</div>

<p>
<b>Group example: Client side</b>
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">object</span> <span style="color: #6c71c4;">StatsSampleClient</span> {&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">def</span> <span style="color: #6c71c4;">main</span>(args: Array[String]): Unit = {&#57344;&#57345;&#57345;
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">note that client is not a compute node, role not defined</span>&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">system</span> = ActorSystem(<span style="color: #2aa198;">"ClusterSystem"</span>)&#57344;&#57345;&#57345;
    system.actorOf(Props(classOf[StatsSampleClient], <span style="color: #2aa198;">"/user/statsService"</span>), <span style="color: #2aa198;">"client"</span>)&#57344;&#57345;
  }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #859900;">class</span> <span style="color: #268bd2;">StatsSampleClient</span>(servicePath: String) <span style="color: #859900;">extends</span> <span style="color: #268bd2;">Actor</span> {&#57344;&#57345;&#57345;
  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">servicePath is "/user/statsService", which is the second argument of the Props.</span>&#57344;&#57345;
  <span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">cluster</span> = Cluster(context.system)&#57344;&#57345;&#57345;
  val servicePathElements = servicePath match {&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> RelativeActorPath(elements) =&gt; {&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">//      </span><span style="color: #93a1a1; font-style: italic;">println("servicePath is: "+servicePath) ;</span>&#57344;&#57345;&#57345;
      elements}&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> _ =&gt; <span style="color: #859900;">throw</span> <span style="color: #859900;">new</span> <span style="color: #268bd2;">IllegalArgumentException</span>(&#57344;&#57345;&#57345;
      <span style="color: #2aa198;">"servicePath [%s] is not a valid relative actor path"</span> format servicePath)&#57344;&#57345;
  }&#57344;&#57345;&#57345;
  <span style="color: #859900;">import</span> context.<span style="color: #268bd2;">dispatcher</span>&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">tickTask</span> = context.system.scheduler.schedule(2.seconds, 10.seconds, self, <span style="color: #2aa198;">"tick"</span>)&#57344;&#57345;
&#57344;&#57345;&#57345;
  var nodes = Set.empty[Address]&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  override def preStart(): Unit = {&#57344;&#57345;&#57345;
    cluster.subscribe(self, classOf[MemberEvent], classOf[ReachabilityEvent])&#57344;&#57345;
  }&#57344;&#57345;&#57345;
  override <span style="color: #268bd2;">def</span> <span style="color: #b58900;">postStop</span>(): Unit = {&#57344;&#57345;&#57345;
    cluster.unsubscribe(self)&#57344;&#57345;&#57345;
    tickTask.cancel()&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">def</span> <span style="color: #6c71c4;">receive</span> = {&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> <span style="color: #2aa198;">"tick"</span> <span style="color: #859900;">if</span> nodes.nonEmpty =&gt;&#57344;&#57345;&#57345;
      <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">just pick any one</span>&#57344;&#57345;&#57345;
      val address = nodes.toIndexedSeq(ThreadLocalRandom.current.nextInt(nodes.size))&#57344;&#57345;
      val service = context.actorSelection(<span style="color: #268bd2;">RootActorPath</span>(<span style="color: #268bd2;">address</span>) / servicePathElements)&#57344;&#57345;
      service <span style="color: #268bd2;">!</span> StatsJob(<span style="color: #2aa198;">"this is the text that will be analyzed"</span>)&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> result: StatsResult =&gt;&#57344;&#57345;&#57345;
      println(result)&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> failed: JobFailed =&gt;&#57344;&#57345;&#57345;
      println(failed)&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> state: CurrentClusterState =&gt;&#57344;&#57345;&#57345;
      nodes = state.members.collect {&#57344;&#57345;&#57345;
        <span style="color: #859900;">case</span> m <span style="color: #859900;">if</span> m.hasRole(<span style="color: #2aa198;">"compute"</span>) &amp;&amp; m.status == <span style="color: #268bd2;">MemberStatus</span>.Up =&gt; m.address&#57344;&#57345;
      }&#57344;&#57345;&#57345;
    <span style="color: #859900;">case</span> MemberUp(m) <span style="color: #859900;">if</span> m.hasRole(<span style="color: #2aa198;">"compute"</span>)        =&gt; nodes += m.address&#57344;&#57345;
    <span style="color: #859900;">case</span> other: MemberEvent                         =&gt; nodes -= other.member.address&#57344;&#57345;
    <span style="color: #859900;">case</span> UnreachableMember(m)                       =&gt; nodes -= m.address&#57344;&#57345;
    <span style="color: #859900;">case</span> ReachableMember(m) <span style="color: #859900;">if</span> m.hasRole(<span style="color: #2aa198;">"compute"</span>) =&gt; nodes += m.address&#57344;&#57345;
  }&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
<p>
而在客户端代码中,首先向cluster订阅成员事件来获取所有的成员. 然后
根据成员的role来筛选出相应的node. 真正开始发送任务的时候,随机排
列这些node,然后使用
<code>context.actorSelection(RootActorPath(address) /
      servicePathElements)</code> 这句话返回一个 <code>ActorSelection</code> 的对象,对它
发送信息能自动地发送到某个注册在cluster上的某个node上的某个actor
上面去.准确地说,后半段确定Actor的URN,前半段应该是URL.
</p>
</div>
</div>

<div id="outline-container-sec-2-3-2" class="outline-4">
<h4 id="sec-2-3-2"><span class="section-number-4">2.3.2</span> <b>Pool router</b></h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
利用ClusterSingletonManager作为StatsService的外包,虽然每个node上
都运行了创建代码,但实际上只有一个StatsService被创建,从而实现单例.
在node被创建之后,node沟通其它node并加入cluster,随后连接上singleton
下的statsService,如果是第一个node则会创建router,然后创建3个
worker. 之后的node直接在连上statsService之后创建3个worker. worer是
由workerRouter创建的,3个worker的设定在配置文件里
<code>max-nr-of-instances-per-node = 3</code>. 这个设定只对pool有效,group里
面就算设定了也不会创建worker.
</p>

<p>
<i>singlton意味着Actor在整个集群上只有一个,目前看来是先创建的node
上面载有这个单例,如果这个node挂了怎么办?</i>
</p>

<p>
singletonManager 被映射到 /user/singleton 上作为 StatsService 的
容器, StatsService 自然就映射到其下
<code>/user/singleton/statsService</code>.
</p>
</div>
</div>
</div>


<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Adaptive Load Balancing</h3>
<div class="outline-text-3" id="text-2-4">
<p>
AdaptiveLoadBalanceing <b>Pool</b> 和 AdaptiveLoadBalancing <b>Group</b> 两种
实现方式.中心是cluster metrics和配置adaptive的router.
</p>
<ol class="org-ol">
<li>注意,不要在 <code>preStart</code> 里面发送信息,这个时候路由还没有设置好,发
送的message全部/部分都会变成 <i>dead letter</i>.
</li>
<li>另外一个坑是:router会按照算法把负载分布到cluster的每个node上去.在
例子中,用role来区分前后端的node,所以router只会向后端node发送信
息.但是后端node不代表有后端actor,这一点router是无法探知的.所以
如果你把只运行有前端actor的node也标记为后端,router仍然会向其发
送信息,最后会导致信息送丢了. <b>node的身份取只决于system config里
面的role,不取决于里面到底运行了什么actor.</b>
</li>
<li>追加一个坑:不要在callback里面调用任何状态相关的函数,除非你确定
你需要这个副作用.在callback里面调用 <code>sender()</code> 经常会返回
<code>deadLetter</code>, 因为 <code>sender()</code> 真正被调用的时候不是接收到信息的
时候.
</li>
</ol>
</div>
</div>
</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-03-04T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-03-04-spring-tutorial.html" itemprop="url">Spring Tutorial</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Project file structure</a></li>
<li><a href="#sec-2">2. Management with Maven</a></li>
<li><a href="#sec-3">3. Application Configuration</a>
<ul>
<li><a href="#sec-3-1">3.1. Inject configurations</a></li>
<li><a href="#sec-3-2">3.2. Load configuration files.</a></li>
<li><a href="#sec-3-3">3.3. Define configuration source class</a></li>
<li><a href="#sec-3-4">3.4. Automatically assign properties.</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Authentication &amp; Securing</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-03-04-spring-tutorial.html"><span class="section-number-2">1</span> Project file structure</a></h2>
<div class="outline-text-2" id="text-1">
<p>
Generally, we use maven to manage the directory layout. Hence, you
will get a <b>standard directory</b> layout like below:
</p>
<div class="org-src-container">

<pre class="src src-bash">project
    src
        main
            java
            [scala]
            resources
                environment.properties
                environment.test.properties
                environment.prod.properties
                config
                    application.yml
                    application-dev.yml
                    application-[profile].yml
                [other]
        test
            java
            [scala]
    target
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Management with Maven</h2>
<div class="outline-text-2" id="text-2">
<p>
The files <code>environment.[profile].properties</code> are used to provide
different profiles to <b><a href="http://maven.apache.org/guides/mini/guide-building-for-different-environments.html">maven</a></b>.
</p>

<p>
Since maven is used to manage the package dependencies, different
maven profiles enables you to use different dependencies for
development and production, e.g. run different tasks. I am not
farmiliar with maven, and cannot tell how and when it can be used.
</p>

<p>
You have to add <code>spring-boot-maven-plugin</code> as one of the plugins
under <code>build</code> node in pom.xml.
</p>
<ul class="org-ul">
<li>Development
<ul class="org-ul">
<li>Compile the project by <code>maven clean insatll</code>
</li>
<li>More than Build

<p>
Maven can help running test, web application and produceing
reports by plugins. TODO
</p>
</li>
<li><b>Compile and run</b>: <code>mvn spring-boot:run</code> to run the
application with default profile; <code>mvn -Pprod spring-boot:run</code>
to run the application with <i>prod</i> profile.
</li>
</ul>
</li>
<li>Production
<ul class="org-ul">
<li>Package the files

<ul class="org-ul">
<li><b>Jar file</b>. Run <code>mvn clean package</code> to build the jar file
and run it through command line.
</li>

<li><b>War file</b>. Add <code>&lt;packaging&gt;war&lt;/packaging&gt;</code> in pom.xml
file, under the root node. Then run <code>mvn package</code> as
building the jar file.
</li>
</ul>
</li>

<li>Deploy
</li>
</ul>
</li>
</ul>

<p>
From command line, you can run the jar file with specification of
profile.
</p>
<div class="org-src-container">

<pre class="src src-bash">java -jar -Dspring.profiles.active=production YOUR_JAR.jar
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Application Configuration</h2>
<div class="outline-text-2" id="text-3">
<p>
The files <code>application-[profile].yml</code> are used to provide different
configurations for <b><a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/Configuration.html">spring</a></b>.
</p>

<p>
Spring configuration files let you to inject different
configurations for development and production. For example, you can
use different database for development and production (different
host, port, username and password, etc.).
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Inject configurations</h3>
<div class="outline-text-3" id="text-3-1">
<p>
You can get access to these configurations through many ways
</p>
<ul class="org-ul">
<li>Inject the value of configuration to attribute of this class by
<code>@Value("${NAME:DEFAULT_VALUE}")</code>.
</li>
<li>You can also inject <code>Environment</code> object.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">This line is not about get the property, but about define</span>&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">property and let it accessible by somewhere else.</span>&#57344;&#57345;&#57345;
<span style="color: #268bd2;">@Configuration</span>&#57344;&#57345;&#57345;
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">AppConfig</span> {&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Inject</span> <span style="color: #268bd2;">Environment</span> <span style="color: #6c71c4;">env</span>;&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Bean</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">MyBean</span> <span style="color: #b58900;">myBean</span>() {&#57344;&#57345;&#57345;
        <span style="color: #268bd2;">MyBean</span> <span style="color: #6c71c4;">myBean</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">MyBean</span>();&#57344;&#57345;&#57345;
        myBean.setName(env.getProperty(<span style="color: #2aa198;">"bean.name"</span>));&#57344;&#57345;&#57345;
        <span style="color: #859900;">return</span> myBean;&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
</li>
<li>You can also implement the <code>EnvironmentAware</code> interface to get
an environment object to get the property.
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">MailConfiguration</span> <span style="color: #859900;">implements</span> <span style="color: #268bd2;">EnvironmentAware</span> {&#57344;&#57345;&#57345;
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">setEnvironment</span>(<span style="color: #268bd2;">Environment</span> <span style="color: #6c71c4;">environment</span>) {&#57344;&#57345;&#57345;
        <span style="color: #859900;">this</span>.propertyResolver = <span style="color: #859900;">new</span> <span style="color: #268bd2;">RelaxedPropertyResolver</span>(environment, ENV_SPRING_MAIL);&#57344;&#57345;
    }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
</li>
</ul>

<p>
One difference between <code>Environment</code> and <code>@Value</code> is that we can
access the information related to profiles. The environment can
determine which profiles are currently active, and which profile
should be active by default.
</p>
<div class="org-src-container">

<pre class="src src-java">env.acceptsProfiles(<span style="color: #268bd2;">String</span>... <span style="color: #6c71c4;">profiles</span>)&#57344;&#57345;&#57345;
env.getActiveProfiles() <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">return an array of strings</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
<code>Environment</code> interface extends <code>PropertyResolver</code>, which is used
to acess the properties. You can get property directly from the
environment object. The example above provide a way that get
properties by key name following a relaxed rule.
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Load configuration files.</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Different property sources are loaded in predefined order. You
can set the default additional property file by
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">SimpleCommandLinePropertySource</span> <span style="color: #6c71c4;">source</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">SimpleCommandLinePropertySource</span>(args);&#57344;&#57345;
<span style="color: #859900;">if</span> (<span style="color: #268bd2;">!</span>source.containsProperty(<span style="color: #2aa198;">"spring.profiles.active"</span>)){&#57344;&#57345;&#57345;
    app.setAdditionalProfiles([profile_name])&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Define configuration source class</h3>
<div class="outline-text-3" id="text-3-3">
<p>
 A class is recognized as a source of configuration if it has the
<code>@Configuration</code> class. <code>@Bean</code> defined in this class can be
accessed from <code>AnnotationConfigApplicationContext</code>. It is a
replacement of XML configuration files that defines beans.
Get the configuration from configuration class in some where
else.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">ConfigurationTest</span> {&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Test</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">testHelloworld</span> () {&#57344;&#57345;&#57345;
        <span style="color: #268bd2;">AnnotationConfigApplicationContext</span> <span style="color: #6c71c4;">ctx</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">AnnotationConfigApplicationContext</span>(AppConfig.<span style="color: #859900;">class</span>);&#57344;&#57345;
        Assert.assertEquals(<span style="color: #2aa198;">"hello"</span>, ctx.getBean(<span style="color: #2aa198;">"message"</span>)); <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">message is the name of the Bean method in configuration class</span>&#57344;&#57345;
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">it can also be used to get any kind of object</span>&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
<p>
<code>AppConfig</code> is the class that used as configuration source.
</p>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Automatically assign properties.</h3>
<div class="outline-text-3" id="text-3-4">
<p>
In configuration source, add
<code>@EnableConfigurationProperties(A.class)</code>. In target class <code>A</code>,
add <code>@ConfigurationProperties(prefix = "PREFIX")</code>. Then the
properties under <code>PREFIX</code> will be automatically assigned to the
attributes of class <code>A</code>. <b>DETAILS OF THE CONFIGURATION SOURCE</b>???
</p>

<p>
<code>@EnableAutoConfiguration</code> auto configure the application. I
don&#8217;t know the details of this annotation, but it auto wires the
configurations into the embedded tomcat. Besides, it also
configures the database (host and port) automatically when
database template is injected in the project.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Authentication &amp; Securing</h2>
<div class="outline-text-2" id="text-4">
<p>
It is mainly implemented by <code>HttpSecurity</code>, which can be injected
and configured in method of class that extends
<code>WebSecurityConfigurerAdapter</code>.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">SecurityConfig</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">WebSecurityConfigurerAdapter</span> {&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Inject</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">private</span> <span style="color: #268bd2;">UserDetailsService</span> <span style="color: #6c71c4;">userDetailsService</span>;&#57344;&#57345;&#57345;
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">class access to the user database</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Value</span>(<span style="color: #2aa198;">"${drill.security.rememberme.key}"</span>)&#57344;&#57345;&#57345;
    <span style="color: #859900;">private</span> <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">remerberMeKey</span>;&#57344;&#57345;&#57345;
    <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">key for cookies</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Inject</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">configureGlobal</span>(<span style="color: #268bd2;">AuthenticationManagerBuilder</span> <span style="color: #6c71c4;">auth</span>) <span style="color: #859900;">throws</span> <span style="color: #268bd2;">Exception</span> {&#57344;&#57345;
        auth&#57344;&#57345;&#57345;
            .userDetailsService(userDetailsService) <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">the point that connect the authentication module and user database</span>&#57344;&#57345;
            .passwordEncoder(passwordEncoder());&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Override</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">configure</span>(<span style="color: #268bd2;">WebSecurity</span> <span style="color: #6c71c4;">web</span>) <span style="color: #859900;">throws</span> <span style="color: #268bd2;">Exception</span> {&#57344;&#57345;&#57345;
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Spring security ignore following URL</span>&#57344;&#57345;&#57345;
        web.ignoring()&#57344;&#57345;&#57345;
            .antMatchers(<span style="color: #2aa198;">"/bower_components/**"</span>)&#57344;&#57345;&#57345;
            .antMatchers(<span style="color: #2aa198;">"/fonts/**"</span>)&#57344;&#57345;&#57345;
            .antMatchers(<span style="color: #2aa198;">"/images/**"</span>)&#57344;&#57345;&#57345;
            ...;&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Override</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">configure</span>(<span style="color: #268bd2;">HttpSecurity</span> <span style="color: #6c71c4;">http</span>) <span style="color: #859900;">throws</span> <span style="color: #268bd2;">Exception</span> {&#57344;&#57345;&#57345;
        http.authorizeRequests()&#57344;&#57345;&#57345;
                .antMatchers(<span style="color: #2aa198;">"/app/**"</span>).authenticated()&#57344;&#57345;&#57345;
                .antMatchers(<span style="color: #2aa198;">"/app/rest/register"</span>).permitAll()&#57344;&#57345;&#57345;
                .antMatchers(<span style="color: #2aa198;">"/app/rest/logs/**"</span>).hasAuthority(<span style="color: #268bd2;">Authority</span>.ADMIN)&#57344;&#57345;
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">set authorities</span>&#57344;&#57345;&#57345;
            .and()&#57344;&#57345;&#57345;
                .formLogin()&#57344;&#57345;&#57345;
                .usernameParameter(<span style="color: #2aa198;">"username"</span>)&#57344;&#57345;&#57345;
                .passwordParameter(<span style="color: #2aa198;">"password"</span>)&#57344;&#57345;&#57345;
                .loginProcessingUrl(<span style="color: #2aa198;">"/app/authentication"</span>)&#57344;&#57345;&#57345;
                .successHandler(ajaxAuthenticationSuccessHandler)&#57344;&#57345;&#57345;
                .failureHandler(ajaxAuthenticationFailureHandler)&#57344;&#57345;&#57345;
                .permitAll()&#57344;&#57345;&#57345;
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">set login service url</span>&#57344;&#57345;&#57345;
            .and()&#57344;&#57345;&#57345;
                .logout()&#57344;&#57345;&#57345;
                .logoutUrl(<span style="color: #2aa198;">"/app/logout"</span>)&#57344;&#57345;&#57345;
                .logoutSuccessHandler(ajaxLogoutSuccessHandler)&#57344;&#57345;&#57345;
                .deleteCookies(<span style="color: #2aa198;">"JSESSIONID"</span>)&#57344;&#57345;&#57345;
                .permitAll()&#57344;&#57345;&#57345;
            .and()&#57344;&#57345;&#57345;
                .exceptionHandling()&#57344;&#57345;&#57345;
                .authenticationEntryPoint(authenticationEntryPoint)&#57344;&#57345;&#57345;
            .and()&#57344;&#57345;&#57345;
                .rememberMe()&#57344;&#57345;&#57345;
                .rememberMeServices(rememberMeServices)&#57344;&#57345;&#57345;
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">it is not persistent token</span>&#57344;&#57345;&#57345;
                .key(remerberMeKey)&#57344;&#57345;&#57345;
            .and()&#57344;&#57345;&#57345;
                .csrf().disable()  <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">not clear</span>&#57344;&#57345;&#57345;
                .headers().cacheControl(); <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">not clear</span>&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>

<p>
The foundation of user securing is about session and cookies. Once
the user logged in, the server will set the cookies in
browser. Then browser will send the cookies via HTTP protocol
everytime it send new request to the server. On the server side,
<i>session</i> is also kept with a unique random id to identify the
client. Look another blog <i>Init the project</i> to see how to replace
the in memory user store by a repository that connects to
database. On the server side, programmer can get the user
information by:
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">static</span> <span style="color: #268bd2;">String</span> <span style="color: #b58900;">getCurrentLogin</span>() {&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">SecurityContext</span> <span style="color: #6c71c4;">securityContext</span> = SecurityContextHolder.getContext();&#57344;&#57345;
    <span style="color: #268bd2;">Authentication</span> <span style="color: #6c71c4;">authentication</span> = securityContext.getAuthentication();&#57344;&#57345;
    <span style="color: #268bd2;">UserDetails</span> <span style="color: #6c71c4;">springSecurityUser</span> = <span style="color: #268bd2;">null</span>;&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">String</span> <span style="color: #6c71c4;">userName</span> = <span style="color: #268bd2;">null</span>;&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
    <span style="color: #859900;">if</span>(authentication != <span style="color: #268bd2;">null</span>) {&#57344;&#57345;&#57345;
        <span style="color: #859900;">if</span> (authentication.getPrincipal() <span style="color: #859900;">instanceof</span> UserDetails) {&#57344;&#57345;&#57345;
            springSecurityUser = (<span style="color: #268bd2;">UserDetails</span>) authentication.getPrincipal();&#57344;&#57345;
            userName = springSecurityUser.getUsername();&#57344;&#57345;&#57345;
        } <span style="color: #859900;">else</span> <span style="color: #859900;">if</span> (authentication.getPrincipal() <span style="color: #859900;">instanceof</span> String) {&#57344;&#57345;&#57345;
            userName = (<span style="color: #268bd2;">String</span>) authentication.getPrincipal();&#57344;&#57345;&#57345;
        }&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
    <span style="color: #859900;">return</span> userName;&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
</div>
</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-03-04T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-03-04-spring-guide-examples.html" itemprop="url">Spring Guide Examples</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Start RESTFul Server</a></li>
<li><a href="#sec-2">2. Securing Web</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-03-04-spring-guide-examples.html"><span class="section-number-2">1</span> Start RESTFul Server</a></h2>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Securing Web</h2>
<div class="outline-text-2" id="text-2">
<p>
This example uses WebMvc framework, which uses
<code>WebMvcConfigurerAdapter</code> and <code>ViewControllerRegistry</code> to connect
the urls and html templates.
</p>

<p>
Add <code>spring-boot-starter-security</code> into dependency, make
<code>WebSecurityConfig.java</code>.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">@Configuration</span>&#57344;&#57345;&#57345;
<span style="color: #268bd2;">@EnableWebMvcSecurity</span>&#57344;&#57345;&#57345;
<span style="color: #859900;">public</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">WebSecurityConfig</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">WebSecurityConfigurerAdapter</span> {&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Override</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">protected</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">configure</span>(<span style="color: #268bd2;">HttpSecurity</span> <span style="color: #6c71c4;">http</span>) <span style="color: #859900;">throws</span> <span style="color: #268bd2;">Exception</span> {&#57344;&#57345;&#57345;
        http&#57344;&#57345;&#57345;
            .authorizeRequests()&#57344;&#57345;&#57345;
                .antMatchers(<span style="color: #2aa198;">"/"</span>, <span style="color: #2aa198;">"/home"</span>).permitAll()&#57344;&#57345;&#57345;
                .anyRequest().authenticated()&#57344;&#57345;&#57345;
                .and()&#57344;&#57345;&#57345;
            .formLogin()&#57344;&#57345;&#57345;
                .loginPage(<span style="color: #2aa198;">"/login"</span>)&#57344;&#57345;&#57345;
                .permitAll()&#57344;&#57345;&#57345;
                .and()&#57344;&#57345;&#57345;
            .logout()&#57344;&#57345;&#57345;
                .permitAll();&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">@Autowired</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">public</span> <span style="color: #268bd2;">void</span> <span style="color: #b58900;">configureGlobal</span>(<span style="color: #268bd2;">AuthenticationManagerBuilder</span> <span style="color: #6c71c4;">auth</span>) <span style="color: #859900;">throws</span> <span style="color: #268bd2;">Exception</span> {&#57344;&#57345;
        auth&#57344;&#57345;&#57345;
            .inMemoryAuthentication()&#57344;&#57345;&#57345;
                .withUser(<span style="color: #2aa198;">"user"</span>).password(<span style="color: #2aa198;">"password"</span>).roles(<span style="color: #2aa198;">"USER"</span>);&#57344;&#57345;&#57345;
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">user repository in memory with username = "user" and password = "password"</span>&#57344;&#57345;
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">it is just for demon</span>&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
</div>
</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-02-28T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-02-28-start-maven-example.html" itemprop="url">Start Maven Example</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Simple POM</a></li>
<li><a href="#sec-2">2. Basic command</a></li>
<li><a href="#sec-3">3. Directory layout</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-02-28-start-maven-example.html"><span class="section-number-2">1</span> Simple POM</a></h2>
<div class="outline-text-2" id="text-1">
<p>
Maven projects are defined with an XML file named <i>pom.xml</i>. This
file gives the project&#8217;s name, version, and dependencies that it
has on external libraries. Here is an <a href="http://spring.io/guides/gs/maven/#initial">example</a>.
</p>
<div class="org-src-container">

<pre class="src src-xml">&lt;?<span style="color: #859900;">xml</span> <span style="color: #6c71c4;">version</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">1.0</span><span style="color: #2aa198;">"</span> <span style="color: #6c71c4;">encoding</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">UTF-8</span><span style="color: #2aa198;">"</span>?&gt;&#57344;&#57345;&#57345;
&lt;<span style="color: #b58900;">project</span> <span style="color: #6c71c4;">xmlns</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">http://maven.apache.org/POM/4.0.0</span><span style="color: #2aa198;">"</span> <span style="color: #6c71c4;">xmlns</span>:<span style="color: #6c71c4;">xsi</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">http://www.w3.org/2001/XMLSchema-instance</span><span style="color: #2aa198;">"</span>&#57344;&#57345;
    <span style="color: #6c71c4;">xsi</span>:<span style="color: #6c71c4;">schemaLocation</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd</span><span style="color: #2aa198;">"</span>&gt;&#57344;&#57345;
    &lt;<span style="color: #b58900;">modelVersion</span>&gt;4.0.0&lt;/<span style="color: #b58900;">modelVersion</span>&gt;&#57344;&#57345;&#57345;
    &lt;<span style="color: #b58900;">groupId</span>&gt;org.springframework&lt;/<span style="color: #b58900;">groupId</span>&gt;&#57344;&#57345;&#57345;
    &lt;<span style="color: #b58900;">artifactId</span>&gt;gs-maven&lt;/<span style="color: #b58900;">artifactId</span>&gt;&#57344;&#57345;&#57345;
    &lt;<span style="color: #b58900;">packaging</span>&gt;jar&lt;/<span style="color: #b58900;">packaging</span>&gt;&#57344;&#57345;&#57345;
    &lt;<span style="color: #b58900;">version</span>&gt;0.1.0&lt;/<span style="color: #b58900;">version</span>&gt;&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
    &lt;<span style="color: #b58900;">build</span>&gt;&#57344;&#57345;&#57345;
        &lt;<span style="color: #b58900;">plugins</span>&gt;&#57344;&#57345;&#57345;
            &lt;<span style="color: #b58900;">plugin</span>&gt;&#57344;&#57345;&#57345;
                &lt;<span style="color: #b58900;">groupId</span>&gt;org.apache.maven.plugins&lt;/<span style="color: #b58900;">groupId</span>&gt;&#57344;&#57345;&#57345;
                &lt;<span style="color: #b58900;">artifactId</span>&gt;maven-shade-plugin&lt;/<span style="color: #b58900;">artifactId</span>&gt;&#57344;&#57345;&#57345;
                &lt;<span style="color: #b58900;">version</span>&gt;2.1&lt;/<span style="color: #b58900;">version</span>&gt;&#57344;&#57345;&#57345;
                &lt;<span style="color: #b58900;">executions</span>&gt;&#57344;&#57345;&#57345;
                    &lt;<span style="color: #b58900;">execution</span>&gt;&#57344;&#57345;&#57345;
                        &lt;<span style="color: #b58900;">phase</span>&gt;package&lt;/<span style="color: #b58900;">phase</span>&gt;&#57344;&#57345;&#57345;
                        &lt;<span style="color: #b58900;">goals</span>&gt;&#57344;&#57345;&#57345;
                            &lt;<span style="color: #b58900;">goal</span>&gt;shade&lt;/<span style="color: #b58900;">goal</span>&gt;&#57344;&#57345;&#57345;
                        &lt;/<span style="color: #b58900;">goals</span>&gt;&#57344;&#57345;&#57345;
                        &lt;<span style="color: #b58900;">configuration</span>&gt;&#57344;&#57345;&#57345;
                            &lt;<span style="color: #b58900;">transformers</span>&gt;&#57344;&#57345;&#57345;
                                &lt;<span style="color: #b58900;">transformer</span>&#57344;&#57345;&#57345;
                                    <span style="color: #6c71c4;">implementation</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">org.apache.maven.plugins.shade.resource.ManifestResourceTransformer</span><span style="color: #2aa198;">"</span>&gt;&#57344;&#57345;
                                    &lt;<span style="color: #b58900;">mainClass</span>&gt;hello.HelloWorld&lt;/<span style="color: #b58900;">mainClass</span>&gt;&#57344;&#57345;
                                &lt;/<span style="color: #b58900;">transformer</span>&gt;&#57344;&#57345;&#57345;
                            &lt;/<span style="color: #b58900;">transformers</span>&gt;&#57344;&#57345;&#57345;
                        &lt;/<span style="color: #b58900;">configuration</span>&gt;&#57344;&#57345;&#57345;
                    &lt;/<span style="color: #b58900;">execution</span>&gt;&#57344;&#57345;&#57345;
                &lt;/<span style="color: #b58900;">executions</span>&gt;&#57344;&#57345;&#57345;
            &lt;/<span style="color: #b58900;">plugin</span>&gt;&#57344;&#57345;&#57345;
        &lt;/<span style="color: #b58900;">plugins</span>&gt;&#57344;&#57345;&#57345;
    &lt;/<span style="color: #b58900;">build</span>&gt;&#57344;&#57345;&#57345;
&lt;/<span style="color: #b58900;">project</span>&gt;&#57344;&#57345;&#57345;
</pre>
</div>
<ul class="org-ul">
<li><code>&lt;modelVerion&gt;</code> POM model version
</li>
<li><code>&lt;groupId&gt;</code> Domain name of the group or organization.
</li>
<li><code>&lt;artifactId&gt;</code> Name to the project&#8217;s library artifact (name of
JAR file)
</li>
<li><code>&lt;version&gt;</code> Version of the project
</li>
<li><code>&lt;packaging&gt;</code> How it should be packaged (in JAR or WAR file)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Basic command</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-bash">mvn compile
mvn package
mvn install
</pre>
</div>
<p>
The first command compiles the project, and the <i>.classfiles</i> shold be
in the <i>target/classes</i> directory.
The second command compile the code, run tests and finish by
packaging the code up in a JAR file in the <i>target</i> directory.
Tht third command does the same thing as the second command, then
copy the JAR file into the local <span class="underline">dependency repository</span>, under the
directories with name of groupId, artifactId and version. So on my
machine, its location is
<code>~/.m2/repository/org/springframework/gs-maven/0.1.0/gs-maven-0.1.0.jar</code>.
</p>

<p>
Add dependencies of project into the <i>pom.xml</i> file, in the
<code>&lt;project&gt;</code> element.
</p>
<div class="org-src-container">

<pre class="src src-xml">&lt;<span style="color: #b58900;">dependencies</span>&gt;&#57344;&#57345;&#57345;
     &lt;<span style="color: #b58900;">dependency</span>&gt;&#57344;&#57345;&#57345;
         &lt;<span style="color: #b58900;">groupId</span>&gt;joda-time&lt;/<span style="color: #b58900;">groupId</span>&gt;&#57344;&#57345;&#57345;
         &lt;<span style="color: #b58900;">artifactId</span>&gt;joda-time&lt;/<span style="color: #b58900;">artifactId</span>&gt;&#57344;&#57345;&#57345;
         &lt;<span style="color: #b58900;">version</span>&gt;2.2&lt;/<span style="color: #b58900;">version</span>&gt;&#57344;&#57345;&#57345;
     &lt;/<span style="color: #b58900;">dependency</span>&gt;&#57344;&#57345;&#57345;
 &lt;/<span style="color: #b58900;">dependencies</span>&gt;&#57344;&#57345;&#57345;
</pre>
</div>
<p>
This description will tell the maven to get the <i>joda-time</i> package
as external library. You can specify a <code>&lt;scope&gt;</code> element to specify
if the dependencies are required for compiling the code but will be
provided during runtime by <code>provided</code>; or decalre the dependencies
are only necessary for compiling and running tests.
</p>

<p>
When I compile the command, <i>maven</i> downloads the <i>joda-time</i>
pakcage from <a href="https://repo.maven.apache.org/maven2/joda-time/">https://repo.maven.apache.org/maven2/joda-time/</a>. Does
the maven use its domain when the group id does not contain the
domain by default?
</p>

<p>
<b>You can also create a project from scratch</b>
</p>
<div class="org-src-container">

<pre class="src src-bash">mvn archetype:generate -DgroupId=com.mycompany.app -DartifactId=my-app -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false
</pre>
</div>

<p>
<code>mvn scala:console</code> can launch the scala console with the pom
configurations (you have to specify maven-scala-plugin).
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Directory layout</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-bash">project
    src
        main
            java
            [scala]
            resources
                environment.properties
                environment.test.properties
                environment.prod.properties
                config
                    application.yml
                    application-dev.yml
                    application-[profile].yml
                [other]
        test
            java
            [scala]
    target
        classes
            the classes with the same structure as src/main
            the directories in src/main/resources
        test-classes
            the classes with the same structure as src/mainproject
        xxx.jar
    target
</pre>
</div>
</div>
</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-02-28T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-02-28-principles-of-reactive-programming-on-coursera.html" itemprop="url">Principles of Reactive Programming on Coursera</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Monad</a></li>
<li><a href="#sec-2">2. ScalaCheck &amp; ScalaTest &amp; JUnit</a>
<ul>
<li><a href="#sec-2-1">2.1. Tutorial of ScalaCheck</a></li>
<li><a href="#sec-2-2">2.2. ScalaTest</a>
<ul>
<li><a href="#sec-2-2-1">2.2.1. With JUnit</a></li>
<li><a href="#sec-2-2-2">2.2.2. With ScalaCheck</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-3">3. Async</a>
<ul>
<li><a href="#sec-3-1">3.1. Exception =&gt; Future</a></li>
<li><a href="#sec-3-2">3.2. Iterable =&gt; Observable</a>
<ul>
<li><a href="#sec-3-2-1">3.2.1. Subject</a></li>
<li><a href="#sec-3-2-2">3.2.2. Notification</a></li>
<li><a href="#sec-3-2-3">3.2.3. Subscription</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-02-28-principles-of-reactive-programming-on-coursera.html"><span class="section-number-2">1</span> Monad</a></h2>
<div class="outline-text-2" id="text-1">
<p>
Honestly, I don&#8217;t understand it. But I collect my thoughts about it
here. First, the monda is used to chain operations and if the first
(preceding) operation fails, the whole chain stops. An example that
I understand is the usage of for-expression with pattern match. If
the pattern matches, go next operation, else skip this element.
</p>

<p>
Another point of view is about the unit operation. A monad flatMap
with its unit operation will return the monad itself.
</p>

<p>
<b>My conclusion</b>:
</p>

<p>
A monad is a container that supports operation chain and follows
the monad laws. The basic operations of this container are
<code>flatMap</code> and <code>unit</code>, where <code>flatMap</code> actually accepts a function
that maps each element to a container, then binds these containers
together; <code>unit</code> returns a container given an element. Monad laws
guarantee the reliability of operation chain on these contains.
</p>

<p>
Monad seems like a design pattern that enables the operation chain
along with pattern match in functional programming. Because
<code>flatMap</code> chain with different functions is equivalent to nested
<code>flatMap</code>, the for-expression is a syntax sugar based on <code>flatMap</code>
chain. The advantage of this design pattern is avoding side effect.
</p>

<p>
Generator is created by <code>yield</code> as well as
<b>for-expression</b>. Pay attention, there is no generator
class/type/trait. The genrator created through for-expression has
the same type of the sequence/iterator/stream used in
for-expression. That proves the for-expression is a syntax sugar of
monad types. So, guess what will happen when we create a
for-expression using both <b>list</b> and <b>stream</b>?
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">fibo</span>:Stream[Int] = 1 #:: 1 #:: fibo.zip(fibo.tail).map(x=&gt;x._1+x._2)&#57344;&#57345;
val l = List(1,2,3,4,5)&#57344;&#57345;&#57345;
val lsg = <span style="color: #859900;">for</span>{x &lt;- l; fib &lt;- fibo} yield (x,fib)<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">infinite loop, crash the software/your machine</span>&#57344;&#57345;
val slg = <span style="color: #859900;">for</span>{fib &lt;- fibo; x &lt;- l} yield (x,fib)<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">return a stream</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
Following the definition of Monad, the first mixture <code>lsg</code> actually
makes <code>l flatMap (x =&gt; fibo)</code>, which returns a List that tries to
expand infinite stream <code>fibo</code>, hence block your machine. The second
mixture <code>slg</code> returns a Stream that expand the list <code>l</code>, hence,
works well. Besides, I have to clarify one thing: different monads
demonstrated above all accept <code>GenTraversableOnce</code> as parameter and
return monad of their own type. That is why they can be mixed
together and the first expression decides the type of the final
output of for-expression.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> ScalaCheck &amp; ScalaTest &amp; JUnit</h2>
<div class="outline-text-2" id="text-2">
<p>
In the example provided by the oneline course, they used <b>JUnit</b>,
<b>ScalaTest</b> and <b>ScalaCheck</b> together. In their example, the class
of <code>Properties</code> is in <code>src/main/scala</code> and is called by another
class defined under <code>src/test/scala</code>. In the class under test
folder, many instances of the <code>Properties</code> class are created to
check different children classes of the target class.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">abstract</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">QuickCheckHeap</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">Properties</span>(<span style="color: #2aa198;">"Heap"</span>) with IntHeap {&#57344;&#57345;
&#57344;&#57345;&#57345;
  property(<span style="color: #2aa198;">"min1"</span>) = forAll { <span style="color: #268bd2;">a</span>: Int =&gt;&#57344;&#57345;&#57345;
    val h = insert(a, empty)&#57344;&#57345;&#57345;
    findMin(h) == a&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  lazy <span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">genHeap</span>: Gen[H] = <span style="color: #859900;">for</span> {&#57344;&#57345;&#57345;
    a &lt;- arbitrary[Int]&#57344;&#57345;&#57345;
    h &lt;- oneOf(value(empty), genHeap)&#57344;&#57345;&#57345;
  } <span style="color: #268bd2;">yield</span> <span style="color: #b58900;">insert</span>(<span style="color: #268bd2;">a</span>, <span style="color: #268bd2;">h</span>)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
  implicit lazy val arbHeap: Arbitrary[H] = Arbitrary(genHeap)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">@RunWith</span>(<span style="color: #268bd2;">classOf</span>[JUnitRunner])&#57344;&#57345;&#57345;
<span style="color: #859900;">class</span> <span style="color: #268bd2;">QuickCheckSuite</span> <span style="color: #859900;">extends</span> <span style="color: #268bd2;">FunSuite</span> with Checkers {&#57344;&#57345;&#57345;
  <span style="color: #268bd2;">def</span> <span style="color: #b58900;">checkBogus</span>(p: Prop) {&#57344;&#57345;&#57345;
    <span style="color: #268bd2;">var</span> <span style="color: #6c71c4;">ok</span> = <span style="color: #268bd2;">false</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">try</span> {&#57344;&#57345;&#57345;
      check(p)&#57344;&#57345;&#57345;
    } <span style="color: #859900;">catch</span> {&#57344;&#57345;&#57345;
      <span style="color: #859900;">case</span> e: TestFailedException =&gt;&#57344;&#57345;&#57345;
        ok = <span style="color: #268bd2;">true</span>&#57344;&#57345;&#57345;
    }&#57344;&#57345;&#57345;
    assert(ok, <span style="color: #2aa198;">"A bogus heap should NOT satisfy all properties. Try to find the bug!"</span>)&#57344;&#57345;
  }&#57344;&#57345;&#57345;
  <span style="color: #b58900;">test</span>(<span style="color: #2aa198;">"Binomial heap satisfies properties."</span>) {&#57344;&#57345;&#57345;
    check(<span style="color: #859900;">new</span> <span style="color: #268bd2;">QuickCheckHeap</span> with BinomialHeap)&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
  <span style="color: #b58900;">test</span>(<span style="color: #2aa198;">"Bogus (1) binomial heap does not satisfy properties."</span>) {&#57344;&#57345;&#57345;
    checkBogus(<span style="color: #859900;">new</span> <span style="color: #268bd2;">QuickCheckHeap</span> with Bogus1BinomialHeap)&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
  <span style="color: #b58900;">test</span>(<span style="color: #2aa198;">"Bogus (2) binomial heap does not satisfy properties."</span>) {&#57344;&#57345;&#57345;
    checkBogus(<span style="color: #859900;">new</span> <span style="color: #268bd2;">QuickCheckHeap</span> with Bogus2BinomialHeap)&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
  <span style="color: #b58900;">test</span>(<span style="color: #2aa198;">"Bogus (3) binomial heap does not satisfy properties."</span>) {&#57344;&#57345;&#57345;
    checkBogus(<span style="color: #859900;">new</span> <span style="color: #268bd2;">QuickCheckHeap</span> with Bogus3BinomialHeap)&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
  <span style="color: #b58900;">test</span>(<span style="color: #2aa198;">"Bogus (4) binomial heap does not satisfy properties."</span>) {&#57344;&#57345;&#57345;
    checkBogus(<span style="color: #859900;">new</span> <span style="color: #268bd2;">QuickCheckHeap</span> with Bogus4BinomialHeap)&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
  <span style="color: #b58900;">test</span>(<span style="color: #2aa198;">"Bogus (5) binomial heap does not satisfy properties."</span>) {&#57344;&#57345;&#57345;
    checkBogus(<span style="color: #859900;">new</span> <span style="color: #268bd2;">QuickCheckHeap</span> with Bogus5BinomialHeap)&#57344;&#57345;&#57345;
  }&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Tutorial of ScalaCheck</h3>
<div class="outline-text-3" id="text-2-1">
<p>
It is a tool for <b>property-based</b> testing for scala. It has <b>NO</b>
external dependencies and integrated in the test frameworks
<b>ScalaTest</b>. It can also be used standalone, with its built-in test
runner.
First, create a class that extends class
<code>org.scalacheck.Properties</code> with the name of data object that you
want to test. It is used for the library to generate test data to
test your algorithm.
</p>

<p>
Second, create test case by
</p>
<div class="org-src-container">

<pre class="src src-java">property(<span style="color: #2aa198;">"NAME_OF_FUNCTION"</span>) = forAll{&#57344;&#57345;&#57345;
    CONTAINER_OF_DATA =&gt; TEST_CASE_WITH_TARGET_FUNCTION&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
<p>
<code>forAll</code> is the function <code>org.scalacheck.Prop.forAll</code>.
</p>

<p>
Third, to run the tests, you can put the properties in
<code>src/test/scala</code> then use test task to check them.
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> ScalaTest</h3>
<div class="outline-text-3" id="text-2-2">
<p>
This is a test framework that integrates all together. ScalaTest
provides many test styles: <code>FunSuit</code>, <code>FlatSpec</code>, <code>FuncSpec</code>,
<code>WordSpec</code>, <code>FreeSpec</code>, <code>Spec</code>, <code>PropSpec</code>, <code>FeatureSpec</code>. They
are mainly different on syntax styles. It is recommanded that the
user creates a base class that extends all the required features
(as a subset of all the provided features) and extends this base
class through everywhere of the project to make the style
consistent.
</p>
</div>

<div id="outline-container-sec-2-2-1" class="outline-4">
<h4 id="sec-2-2-1"><span class="section-number-4">2.2.1</span> With JUnit</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
This class uses the junit framework for unittest. JUnit will
invoke the class with <code>@RunWith</code> annotation (extend by type
hierarchies) to run the tests. The annotation parameter in the
example is a class of the type <code>JUnitRunner</code>. In fact, any class
extends <code>Runner</code> is acceptabel. Notice that function <code>classOf</code>
acts the same as <code>obj.getClass()</code>.
</p>

<p>
<b>Maven</b> Running tests with command <code>mvn test</code>. In fact, you
<b>cannot</b> run the tests with the example above. <b>Solution</b> is to
change the name <code>QuickCheckSuite</code> to <code>QuickCheckSuiteTest</code> or
<code>TestQuickCheckSuite</code> or <code>QuickCheckSuiteTestCase</code> to run the
tests. Even I did not explicitly specify plugin <code>surefire</code>, maven
uses this plugin to run test with my configuration. By default,
maven following name convertions when looking for tests to
run. So I have to change the name or modify the <code>surefire</code>
configuration to apply new name convertion rules.
</p>

<p>
The annotation uses class of <code>JUnitRunner</code> as parameter. This
class is provided by scala-test framework that connect
scala-test and junit.
</p>
<ul class="org-ul">
<li>As mentioned on <a href="http://www.scalatest.org/user_guide/using_the_scalatest_maven_plugin">ScalaTest Maven Plugin</a>, you can run tests
without this annotation by using this plugin. <b>TODO</b>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-2-2" class="outline-4">
<h4 id="sec-2-2-2"><span class="section-number-4">2.2.2</span> With ScalaCheck</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
To work with ScalaCheck, you have to mix the trait
<code>org.scalatest.prop.Checkers</code> to your test class. <code>Checkers</code>
class contains <code>check</code> method to perform ScalaCheck property
checks, which are provided in the class <code>QuickCheckHeap</code> in the
example above. In fact, you can also use the <code>check</code> method in
JUnit directly. This method will generate a large number of
possible inputs to look for an input that the property does not
hold.
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Async</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Exception =&gt; Future</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Exception is handled by <b>Try[T]</b>, which is used as return type like
Option. But Try[T] maches Success with result or Failure with
throwable. As Try[T] is also a monad, operations of element T are
usually propagated to monad methods of Try[T] to get a new Try[U],
<b>map Try[T] by f should return a new Try[f(T)]</b>.
</p>

<p>
<b>Future[T]</b> is a container of Try[T]. User provide
operations/callbacks that deal with Try[T] and future will call
them at certain time. <b>Future</b> and <b>Try</b> form a nested monad,
monad operations are propagated and you cannot see direct
operation on T in the source code of scala library. But take it
easy, usually, you won&#8217;t have to do it yourself.
</p>

<p>
To <b>get/compose</b> a future (that can be our job), therer are four
methods:
</p>
<ol class="org-ol">
<li>Use the member function of a <code>Future</code> such as <code>flatMap</code>
<ol class="org-ol">
<li><code>flatMap</code>, binary bind operation of futures. Register promise
to <i>this</i> when failed of exception of call funtion; register
promise to <i>that</i> when successed.
</li>
<li><code>onComplete</code>, parameter is a function <code>Try[T] =&gt; U</code>. This is
a funtamental funciton of <code>map</code>, <code>foreach</code>, <code>failed</code>, etc. It
propagate the Try mechanism.
</li>
<li><code>collect</code>
</li>
<li><code>recover</code>
</li>
<li><code>fallbackTo</code>
</li>
<li><code>zip</code>
</li>
<li><code>andThen</code>
</li>
</ol>
</li>
<li>Create a promise and register the complete method to current
futures, then return a new Future of this promise.

<p>
<code>Promise</code> acts like a mailbox, to compose a new future, the old
future has to put the result, which is a Try[T], into the
promise by <code>complete</code> method. Then the new future will call its
callback when the <code>complete</code> of promise is called.
</p>

<p>
In my opinion, promise can be merged with feature as one
unit. Because it is more straight to think in the way that:
<i>feature calls the callbacks when it is completed</i>. In fact,
the <code>DefaultPromise</code> is actually extends the <code>Future</code> trait. Of
course, the designers of scala have their proper reason.
</p>

<p>
Currently, I think promise is used in race (concurrent
processing of futures results) or to provide a new future for
initailization of fold operations.
</p>
</li>
<li>Use <code>for-expression</code>, which is a syntax sugar of <code>flatMap</code>
</li>
<li>Use <code>async...await</code> grammar.
<ol class="org-ol">
<li><b>The scala implementation of await
is translated to onComplete by the macro</b>.
</li>
<li><b>await method throw
directly the excepetion when future failed</b>.
</li>
</ol>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Iterable =&gt; Observable</h3>
<div class="outline-text-3" id="text-3-2">
<p>
<code>Try</code> and <code>Future</code> are dual, so as <code>Iterable</code> and
<code>Observable</code>. For iterable, you can get an iterator and using
<code>hasNext</code> and <code>next</code> to get elements. For <code>Obserable</code>, you use
<code>Subscribe</code> and <code>onNext</code>, <code>onComplete</code> to get elements.
</p>

<p>
<code>flatten</code> after <code>map</code> returns an observable that merges several
streams randomly. <code>concat</code> after <code>map</code> returns an observable, in
which, elements of each stream are grouped together sequentially
as well as the order of the streams.
</p>

<p>
<b>Don&#8217;t understand well the way of creating observable with a
function from Observer to Subscription -_-!</b>
</p>
</div>

<div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> Subject</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
It works like promise, which is used as bridge or chain between
Obsever and Observable. Four types of subjects are provided:
</p>
<ol class="org-ol">
<li>PublishSubject: send current value.
</li>
<li>BehaviorSubject: cache the latest output.
</li>
<li>AsyncSubject: cache the final output. You only get the final
output.
</li>
<li>ReplaySubject: cache the whole history.
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> Notification</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
Like Try
</p>
</div>
</div>

<div id="outline-container-sec-3-2-3" class="outline-4">
<h4 id="sec-3-2-3"><span class="section-number-4">3.2.3</span> Subscription</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
a handle that enables process to stop receiving messages from
Observable.
</p>
</div>
</div>
</div>
</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-02-28T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-02-28-pom-configuration.html" itemprop="url">POM Configuration</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Identify our project</a></li>
<li><a href="#sec-2">2. Inheritance</a></li>
<li><a href="#sec-3">3. Tasks</a></li>
</ul>
</div>
</div>

<p>
See example  <a href="http://maven.apache.org/guides/introduction/introduction-to-the-pom.html">POM Configuration</a>.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-02-28-pom-configuration.html"><span class="section-number-2">1</span> Identify our project</a></h2>
<div class="outline-text-2" id="text-1">
<p>
Fully qualified name of project is
&#8220;&lt;groupId&gt;:&lt;artifactId&gt;:&lt;version&gt;&#8221;. If <i>groupId</i> is a domain, it
will be transformed into directory path while downloading. Download
something with <i>groupId=org.X.A</i> from <i>url.com</i> will download
things from <i>url.com/org/X/A</i> in the end.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Inheritance</h2>
<div class="outline-text-2" id="text-2">
<p>
When we have two projects, A and B, A is supposed to be parent
project of B. You have to specify the <i>pom.xml</i> of project B to
indicate that the <i>parent</i> of B is A with the <i>groupId</i>,
<i>artifactId</i> and <i>version</i> of A. You can remove the <i>groupId</i> and
<i>version of B to make A and B have the same /groupId</i> and
<i>version</i>. One can also indicate the <code>&lt;relativePath&gt;</code> for parent
project to put the A and B in the same directory level.
</p>

<p>
B inherite the dependencies from A.所以parent用来继承POM,dependency
用来解决代码依赖. <b>parent的项目在代码上没有关系.</b>
</p>

<p>
The packages downloaded by <i>maven</i> are put under
<i>HOME</i>.m2/repository/.
</p>

<p>
所有 <i>POM.xml</i> 里面的元素都可以用 <code>${project.A.B.C}</code> 的方式进行引用.比
方说如果在 <i>XML</i> 根路径下有这样的结构
<code>&lt;A&gt;&lt;B&gt;lalala&lt;C&gt;blabla&lt;C/&gt;&lt;/B&gt;&lt;/A&gt;</code>, <code>${project.A.B.C}</code> 就等于
<code>blabla</code>.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Tasks</h2>
<div class="outline-text-2" id="text-3">
<p>
首先,maven可以使用一系列的plugin来支持各种功能,包括发布,运行测试等
等.在使用 <code>spring-boot-maven-plugin</code> 的时候,可以用 <code>mvn
   spring-boot:run</code> 来运行程序. <code>spring-boot</code> 应该是plugin的名字, <code>run</code>
则是定义好的task. 在使用 <code>maven-scala-plugin</code> 的时候,如果加入以下设
置
</p>
<div class="org-src-container">

<pre class="src src-xml">&lt;<span style="color: #b58900;">executions</span>&gt;&#57344;&#57345;&#57345;
    &lt;<span style="color: #b58900;">execution</span>&gt;&#57344;&#57345;&#57345;
        &lt;<span style="color: #b58900;">goals</span>&gt;&#57344;&#57345;&#57345;
            &lt;<span style="color: #b58900;">goal</span>&gt;compile&lt;/<span style="color: #b58900;">goal</span>&gt;&#57344;&#57345;&#57345;
            &lt;<span style="color: #b58900;">goal</span>&gt;testCompile&lt;/<span style="color: #b58900;">goal</span>&gt;&#57344;&#57345;&#57345;
        &lt;/<span style="color: #b58900;">goals</span>&gt;&#57344;&#57345;&#57345;
    &lt;/<span style="color: #b58900;">execution</span>&gt;&#57344;&#57345;&#57345;
&lt;/<span style="color: #b58900;">executions</span>&gt;&#57344;&#57345;&#57345;
</pre>
</div>
<p>
运行 <code>mvn scala:testCompile</code> 则只会编译test部分的代码.
</p>
</div>
</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-02-28T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-02-28-functional-programming-on-coursera.html" itemprop="url">Functional Programming on Coursera</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Lambda function</a></li>
<li><a href="#sec-2">2. Type hierachy</a></li>
<li><a href="#sec-3">3. Pattern match</a></li>
<li><a href="#sec-4">4. Collections</a></li>
<li><a href="#sec-5">5. Stream, Iterator, Generator and <code>lazy</code></a>
<ul>
<li><a href="#sec-5-1">5.1. Stream</a></li>
<li><a href="#sec-5-2">5.2. Iterator</a></li>
<li><a href="#sec-5-3">5.3. <code>lazy val</code></a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-02-28-functional-programming-on-coursera.html"><span class="section-number-2">1</span> Lambda function</a></h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>function is value,
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">f</span> = (x:Int) =&gt; x*x&#57344;&#57345;&#57345;
</pre>
</div>
<p>
One difference between <code>def f = ...</code> and <code>val f = ...</code> is: <code>def</code>
is evaluated on call and returns a new function instance every
time.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">val</span> <span style="color: #b58900;">test</span>: () =&gt; Int = {&#57344;&#57345;&#57345;
    println(<span style="color: #2aa198;">"val"</span>)&#57344;&#57345;&#57345;
    val r = <span style="color: #268bd2;">util</span>.Random.nextInt&#57344;&#57345;&#57345;
    () =&gt; r&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">returns the same result every time you call test(),</span>&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">"val" will be printed after definition</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #268bd2;">def</span> <span style="color: #b58900;">test</span>: () =&gt; Int = {&#57344;&#57345;&#57345;
    println(<span style="color: #2aa198;">"def"</span>)&#57344;&#57345;&#57345;
    val r = <span style="color: #268bd2;">util</span>.Random.nextInt&#57344;&#57345;&#57345;
    () =&gt; r&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">returns the difference results every time you call test(),</span>&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">"def" will be printed every time you call it.</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">tt</span> = test&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">acts like the first example</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
val test = () =&gt; <span style="color: #268bd2;">util</span>.Random.nextInt&#57344;&#57345;&#57345;
def test = () =&gt; <span style="color: #268bd2;">util</span>.Random.nextInt&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">they are the same from behavior, you have to call the function by test()</span>&#57344;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">the def declaration actually defined a function that returns a function.</span>&#57344;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">if you type test without parenthesis, you will receive a function value.</span>&#57344;&#57345;
&#57344;&#57345;&#57345;
def test = <span style="color: #268bd2;">util</span>.Random.nextInt&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">this line directly assign the test function to the nextInt function,</span>&#57344;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">you can call the function directly by name without the parenthesis</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
method/expression starts by <code>def</code> will be evaluated when you call
<code>obj.f</code> while those starts by <code>val</code> will be evaluated
once. In addition, if you declare a <code>val</code> that assigns to <code>def</code>,
the <code>def</code> will be evaluated immediately, and the new <code>val</code> acts
like the first case in the examples above.
</p>
</li>
<li>Abbreviation:
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">l</span> = List(1,2,3)&#57344;&#57345;&#57345;
l.map((x) =&gt; x*x)&#57344;&#57345;&#57345;
l.map( x =&gt; x*x) <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">ignore the parenthese</span>&#57344;&#57345;&#57345;
l.map( _ % 2 == 0) <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">ignore the parameter, using the placeholder for expression</span>&#57344;&#57345;
l.map(f(_)) <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">using the placeholder for function</span>&#57344;&#57345;&#57345;
l.map(f) <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">ignore the placeholder for function</span>&#57344;&#57345;&#57345;
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Type hierachy</h2>
<div class="outline-text-2" id="text-2">
<p>
abstract class is like Java, trait is like interface in
Java. However, trait can have parameters and defined methods. In
addition, trait is not abstract class since it cannot has
constructors.
</p>
<ul class="org-ul">
<li>Logical problem: is List&lt;Parent&gt; the parent of List&lt;Childe&gt;?

<p>
It is not true for mutable collection.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">var</span> <span style="color: #6c71c4;">s</span> = <span style="color: #859900;">new</span> <span style="color: #268bd2;">Array</span>[Man](<span style="color: #859900;">new</span> <span style="color: #268bd2;">Man</span>())&#57344;&#57345;&#57345;
var t:Array[Human] = s&#57344;&#57345;&#57345;
t[0] = <span style="color: #859900;">new</span> <span style="color: #268bd2;">Woman</span>()&#57344;&#57345;&#57345;
var m:Man = s[0]<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">what is it? man or woman?</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
But we can use imutable collection.
</p>
</li>

<li>Covariant, Contvariant, Invariant
<ul class="org-ul">
<li>Covariant: defined by Class&lt;+T&gt;, Class&lt;Parent&gt; is the parent of
Class&lt;Child&gt;
</li>

<li>Contvariant: defined by Class&lt;-T&gt;, Function&lt;Parent&gt; is the
child of Function&lt;Child&gt;
</li>
</ul>
<p>
The principle is: child type can do anything that can be done by
parent type.
</p>
</li>

<li>Check Rules and Boundary

<p>
To avoid conflict, the compile force the +T can only be used for
returned type, the -T can only be used for argument type. A
method to by pass this problem is using boundary.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">class</span> <span style="color: #268bd2;">List</span>&lt;+T&gt;{&#57344;&#57345;&#57345;
     <span style="color: #268bd2;">def</span> <span style="color: #6c71c4;">prepend</span>[U &gt;: T](<span style="color: #268bd2;">U</span> <span style="color: #6c71c4;">elem</span>)&#57344;&#57345;&#57345;
}&#57344;&#57345;&#57345;
</pre>
</div>
<p>
Notice that in generic type definition, one can use <code>A&gt;:B</code> and
<code>A&lt;:B</code> to add constraint to the meta type.
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Pattern match</h2>
<div class="outline-text-2" id="text-3">
<p>
Case class enables you to make classes with different parameters
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">abstract</span> <span style="color: #859900;">class</span> <span style="color: #268bd2;">CodeTree</span>&#57344;&#57345;&#57345;
<span style="color: #859900;">case</span> <span style="color: #859900;">class</span> Fork(left: CodeTree, right: CodeTree, chars: List[Char], weight: Int) <span style="color: #859900;">extends</span> <span style="color: #268bd2;">CodeTree</span>&#57344;&#57345;
<span style="color: #859900;">case</span> <span style="color: #859900;">class</span> Leaf(<span style="color: #268bd2;">char</span>: Char, weight: Int) <span style="color: #859900;">extends</span> <span style="color: #268bd2;">CodeTree</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
For the classes listed above, you cannot directly access to any
paramter (field) of <code>Fork</code> or <code>Leaf</code>. You have to use <code>case
   Fork(a,b,_,_)</code> to access to the paramters.
</p>

<p>
<code>case</code> match can also be used in lambda function as a short
version.
</p>
<div class="org-src-container">

<pre class="src src-java">List.map(p =&gt; p._1 * p._2)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
List.map({<span style="color: #859900;">case</span> (x,y) =&gt; x * y})&#57344;&#57345;&#57345;
<span style="color: #93a1a1; font-style: italic;">//</span><span style="color: #93a1a1; font-style: italic;">List.map{case (x,y) =&gt; x * y} also works</span>&#57344;&#57345;&#57345;
</pre>
</div>

<p>
Option calsss used for the condition that the returned type can be
empty/null, etc.
</p>

<p>
If you want to match a variable in context, you have to weither use
a capitalized variable name <code>Variable</code> or wrap it by backticks
<code>`variable`</code>.
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Collections</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>List is a chain while Vector is a tree that each node is an array
that contains 32 elements. Vector groups in depth slowly
<code>log_{32}(N)</code>. Important functions: <code>map</code>, <code>filter</code>,
<code>reduceRight</code>, <code>reduceLeft</code>, <code>foldRight</code>, <code>foldLeft</code>, <code>flatten</code>,
<code>flatMap</code>, <code>take</code>, <code>drop</code>, <code>takeWhile, =dropWhile</code>, <code>span</code>,
<code>group</code>, <code>groupBy</code>.

<p>
Sequence as parameter list is represented by <code>this(par: T*)</code>.
</p>
</li>
<li>Map.
<ul class="org-ul">
<li>The <code>+</code> and <code>++</code> operations overwrite the existing key.
</li>
<li>Initialized by <code>Map(k1-&gt;v1, k2-&gt;v2, k3-&gt;v3)</code>
</li>

<li>Set default value by <code>withDefaultValue</code>, this function returns
a new map (everything in this course are immutable).
</li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Stream, Iterator, Generator and <code>lazy</code></h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Stream</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Stream, acts like sequence, but it does not evaluate until be
called. It can be used to ignore unecessary computation and coding
infinite concepts.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #268bd2;">val</span> <span style="color: #6c71c4;">fibo</span>:Stream[Int] = 1 #:: 1 #:: fibo.zip(fibo.tail).map(x=&gt;x._1+x._2)&#57344;&#57345;
println(fibo.take(10).toList)&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
def from(n: Int): Stream[Int] = n #:: from(n+1) <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">infinite integer stream starts from n</span>&#57344;&#57345;
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">recursive stream</span>&#57344;&#57345;&#57345;
def sieve(s: Stream[Int]): Stream[Int] =&#57344;&#57345;&#57345;
   s.head #:: sieve(s.<span style="color: #268bd2;">tail</span> <span style="color: #6c71c4;">filter</span> (_ % s.head !=0)) <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">stream of primes &#36136;&#25968;</span>&#57344;&#57345;
&#57344;&#57345;&#57345;
val primes = sieve(from(2))&#57344;&#57345;&#57345;
primes.take(10).toList <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">the first 10 primes starts from 2.</span>&#57344;&#57345;&#57345;
</pre>
</div>

<p>
Three ways of using stream
</p>
<ul class="org-ul">
<li>Transform from other collections, then you use functions like
map, etc. to generate new stream.
</li>
<li><code>elem #:: Stream</code>
</li>
<li>Transform from iterator, use for loop to create an iterator with
what you want and then convert it into a stream.
</li>
</ul>

<p>
Because Stream has consistent API as List/Seq/Vector, you can use
it as if you have a collection that contains everything.
</p>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Iterator</h3>
<div class="outline-text-3" id="text-5-2">
<p>
The difference between stream and iterator is stream memories the
values while iterator doesn&#8217;t.
</p>

<p>
Iterator can be used in for-expression. For-expression can
also use <b>pattern match</b>.
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">for</span>{ pattern(x) &lt;- seq; pattern2(y) = x(k); ...} yield ...&#57344;&#57345;&#57345;
</pre>
</div>
<p>
As show in the example above, you can apply pattern to loop on the
elements of sequence, you can even add some simple statements in
the for-expression. It is equivalent to:
</p>
<div class="org-src-container">

<pre class="src src-java">seq.withFilter({<span style="color: #859900;">case</span> pattern(x) =&gt; <span style="color: #268bd2;">true</span>; <span style="color: #859900;">case</span> _ =&gt; <span style="color: #268bd2;">false</span>})&#57344;&#57345;&#57345;
   .map({<span style="color: #859900;">case</span> pattern(x) =&gt; x(k)})&#57344;&#57345;&#57345;
   .withFilter({<span style="color: #859900;">case</span> pattern2(y) =&gt; <span style="color: #268bd2;">true</span>; <span style="color: #859900;">case</span> _ =&gt; <span style="color: #268bd2;">false</span>})&#57344;&#57345;&#57345;
   .map({<span style="color: #859900;">case</span> pattern2(y) =&gt; y})&#57344;&#57345;&#57345;
   ...&#57344;&#57345;&#57345;
</pre>
</div>
<p>
The function <code>withFilter</code> returns a <code>FilterMonadic</code>, which
provides four functions <code>flatMap</code>, <code>map</code>, <code>foreach</code>,
<code>withFilter</code>. It works like list of call backs in programming
point of view.
From wikipedia:
/In functional programming, a monad is a structure that represents computations defined as sequences of steps: a type with a monad structure defines what it means to chain operations, or nest functions of that type together.
</p>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> <code>lazy val</code></h3>
<div class="outline-text-3" id="text-5-3">
<p>
<code>lazy val</code> is only evaluated once when called. You can also define
a lazy parameter by <code>def myFUnc[T](param: =&gt; T)</code>, then the
parameter will be evaluated when it is called in <code>myFunc</code> if the
param is returned by an expression/function.
</p>
</div>
</div>
</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-02-17T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-02-17-mongodb-strategy.html" itemprop="url">Mongodb Strategy</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Two-phase commits</a></li>
<li><a href="#sec-2">2. Concurrency control</a></li>
<li><a href="#sec-3">3. Model</a>
<ul>
<li><a href="#sec-3-1">3.1. Relationships between documents</a>
<ul>
<li><a href="#sec-3-1-1">3.1.1. One-to-One Embeded</a></li>
<li><a href="#sec-3-1-2">3.1.2. One-to-Many Embeded/References</a></li>
</ul>
</li>
<li><a href="#sec-3-2">3.2. Tree Structures</a>
<ul>
<li><a href="#sec-3-2-1">3.2.1. References</a></li>
<li><a href="#sec-3-2-2">3.2.2. Nested Sets</a></li>
</ul>
</li>
<li><a href="#sec-3-3">3.3. Index</a></li>
<li><a href="#sec-3-4">3.4. Others</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-02-17-mongodb-strategy.html"><span class="section-number-2">1</span> Two-phase commits</a></h2>
<div class="outline-text-2" id="text-1">
<p>
Two-phase commits is used to update multiple documents as a fake
atomic operation. The principle of two-phase commits is creating
temporary, inter-media records to support rollback operations
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Concurrency control</h2>
<div class="outline-text-2" id="text-2">
<p>
The first method is adding a label to indicate the current accessing
application.
</p>

<p>
The second method is using the old value of files to update as a part
of query to ensure that the target fields of current document is
not updated.
</p>
<div class="org-src-container">

<pre class="src src-javascript"><span style="color: #859900;">var</span> <span style="color: #6c71c4;">myDoc</span> = db.COLLECTION.findOne<span style="color: #657b83;">(</span>condition<span style="color: #657b83;">)</span>;&#57344;&#57345;&#57345;
<span style="color: #859900;">if</span><span style="color: #657b83;">(</span>myDoc<span style="color: #657b83;">){</span>&#57344;&#57345;&#57345;
   <span style="color: #859900;">var</span> <span style="color: #6c71c4;">oldValue</span> = myDoc.value;&#57344;&#57345;&#57345;
   <span style="color: #859900;">var</span> <span style="color: #6c71c4;">results</span> = db.COLLECTION.update<span style="color: #2aa198;">(</span>&#57344;&#57345;&#57345;
       <span style="color: #b58900;">{</span>&#57344;&#57345;&#57345;
           _id: myDoc._id,&#57344;&#57345;&#57345;
           value: oldValue&#57344;&#57345;&#57345;
       <span style="color: #b58900;">}</span>,&#57344;&#57345;&#57345;
       <span style="color: #b58900;">{</span>&#57344;&#57345;&#57345;
           $inc:<span style="color: #859900;">{</span>value: -fee<span style="color: #859900;">}</span>&#57344;&#57345;&#57345;
       <span style="color: #b58900;">}</span>&#57344;&#57345;&#57345;
       <span style="color: #2aa198;">)</span>&#57344;&#57345;&#57345;
<span style="color: #657b83;">}</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
Another possible option is: if you want to deduct an amount of
money from an account and the rest money should not be negative,
you can use following commands:
</p>
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.update<span style="color: #657b83;">(</span><span style="color: #2aa198;">{</span>_id: id, value: <span style="color: #b58900;">{</span>$gte: fee<span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span>, <span style="color: #2aa198;">{</span>$inc:<span style="color: #b58900;">{</span>value: -fee<span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;
</pre>
</div>
<p>
It means the account will be updated only if the value is enough.
</p>

<p>
The third method is add an unique field (<i>version</i>) to the
document.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Model</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Relationships between documents</h3>
<div class="outline-text-3" id="text-3-1">
</div><div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1"><span class="section-number-4">3.1.1</span> One-to-One Embeded</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Example: <i>patron</i> and <i>address</i>. User informations should be put
together, such as the account info (password, email) and
application relative info (balance in account).
</p>
</div>
</div>

<div id="outline-container-sec-3-1-2" class="outline-4">
<h4 id="sec-3-1-2"><span class="section-number-4">3.1.2</span> One-to-Many Embeded/References</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
It is used for <i>one-to-few</i> such as the authors of a book. One
can use array in a document to model such relations. However, if
the values of embedded elements are few, it is better to save them
in another documents using references. For example, the
publishers of books. Another principle is DO NOT create large
arrays in document. Large arrays in document is inefficient for
three reasons:
</p>
<ul class="org-ul">
<li>When document size is increased, the MongoDB will move the
document, which lead to rewriting the entire document.
</li>
<li>Indexing the elements in array is inefficient.
</li>
<li>Query a large document for a small part of array is
inconvenient.
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Tree Structures</h3>
<div class="outline-text-3" id="text-3-2">
</div><div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> References</h4>
<div class="outline-text-4" id="text-3-2-1">
<ul class="org-ul">
<li>Parent Refs.

<p>
Save each node as a document that contains the reference to the
parent
</p>
</li>

<li>Child Refs

<p>
Save each node as document that contains an array of references
to children nodes.
</p>
</li>

<li>Extension

<p>
It is also useful to add additional relations such as ancestors
of nodes into the document.
</p>

<p>
Another way to accelerate the searching of a tree is
<i>materialize paths</i>. This method add a <code>path</code> attribute that
describe the path using a string. Searching such string requires
using of regular expression, but is faster than the previous
solution.
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> Nested Sets</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
This method is tricky. It likes a binary tree that use values to
indicate the relative nodes.
</p>
<div class="org-src-container">

<pre class="src src-javascript"> db.categories.insert<span style="color: #657b83;">(</span> <span style="color: #2aa198;">{</span> _id: <span style="color: #2aa198;">"Books"</span>, parent: 0, left: 1, right: 12 <span style="color: #2aa198;">}</span> <span style="color: #657b83;">)</span>&#57344;&#57345;
 db.categories.insert<span style="color: #657b83;">(</span> <span style="color: #2aa198;">{</span> _id: <span style="color: #2aa198;">"Programming"</span>, parent: <span style="color: #2aa198;">"Books"</span>, left: 2, right: 11 <span style="color: #2aa198;">}</span> <span style="color: #657b83;">)</span>&#57344;&#57345;
 db.categories.insert<span style="color: #657b83;">(</span> <span style="color: #2aa198;">{</span> _id: <span style="color: #2aa198;">"Languages"</span>, parent: <span style="color: #2aa198;">"Programming"</span>, left: 3, right: 4 <span style="color: #2aa198;">}</span> <span style="color: #657b83;">)</span>&#57344;&#57345;
 db.categories.insert<span style="color: #657b83;">(</span> <span style="color: #2aa198;">{</span> _id: <span style="color: #2aa198;">"Databases"</span>, parent: <span style="color: #2aa198;">"Programming"</span>, left: 5, right: 10 <span style="color: #2aa198;">}</span> <span style="color: #657b83;">)</span>&#57344;&#57345;
&#65532;db.categories.insert<span style="color: #657b83;">(</span> <span style="color: #2aa198;">{</span> _id: <span style="color: #2aa198;">"MongoDB"</span>, parent: <span style="color: #2aa198;">"Databases"</span>, left: 6, right: 7 <span style="color: #2aa198;">}</span> <span style="color: #657b83;">)</span>&#57344;&#57345;
 db.categories.insert<span style="color: #657b83;">(</span> <span style="color: #2aa198;">{</span> _id: <span style="color: #2aa198;">"dbm"</span>, parent: <span style="color: #2aa198;">"Databases"</span>, left: 8, right: 9<span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;
&#57344;&#57345;&#57345;
 <span style="color: #859900;">var</span> <span style="color: #6c71c4;">databaseCategory</span> = db.categories.findOne<span style="color: #657b83;">(</span> <span style="color: #2aa198;">{</span> _id: <span style="color: #2aa198;">"Databases"</span> <span style="color: #2aa198;">}</span> <span style="color: #657b83;">)</span>;&#57345;
 db.categories.find<span style="color: #657b83;">(</span> <span style="color: #2aa198;">{</span> left: <span style="color: #b58900;">{</span> $gt: databaseCategory.left <span style="color: #b58900;">}</span>, right: <span style="color: #b58900;">{</span> $lt: databaseCategory.right <span style="color: #b58900;">}</span> <span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;
</pre>
</div>
<p>
One can retrieve the children nodes by using the left and right
indicators.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Index</h3>
<div class="outline-text-3" id="text-3-3">
<p>
One of the main benefit of indexing is sorting, the application
can quickly find the matched document by traveling through the
ordered indices very quickly
</p>
<ul class="org-ul">
<li>Single field index
</li>
<li>Compound key index<br  />
      Note that if one set compound index by
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.ensureIndex<span style="color: #657b83;">(</span><span style="color: #2aa198;">{</span>key1: 1, key2: -1<span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
It can help the <code>sort</code> funciton using <code>{key1: 1, key2: -1}</code>,
<code>{key1: -1, key2: 1}</code>, but cannot help sorting with the key
<code>{key1: 1, key2: 1}</code>.
</p>
</li>
<li>Multi-key index<br  />
      It refers to using array as index. You cannot using compound key
for two arrays.
</li>
<li>Hased index<br  />
      It is not compatible with multi-key index.
</li>
<li>Geospatial index<br  />
      This index is used to index the geometric data, such as lines,
points, shapes.
</li>
<li>Text index<br  />
      Support text search with language stop words, will use very
large space.
</li>
<li>Hashed index<br  />
      Compute the hash for entire document while <b>??collapse??</b> the
sub-document.
</li>
</ul>

<p>
Index also support properties like:
</p>
<ul class="org-ul">
<li><i>TTL</i> index is used to remove outdated index
</li>
<li><i>Uniqu</i> index, which reject duplicate value of indexed filed for all the document. ??Can we use it to ensure that
elements in array has unique value in document (can be repeat in
different document)??
</li>
<li><i>Sparse</i> index, documents without the field are not indexed. By
default, these documents will be indexed to null.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Others</h3>
<div class="outline-text-3" id="text-3-4">
<ul class="org-ul">
<li>Atomic operation
<code>update</code>, <code>findAddUpdate</code>, <code>remove</code> are atomic. Put fields in one
document can ensure the write operations are atomic.
</li>

<li>Support keyword search
Putting strings in an array, then create a multi-key index
enables keyword search.

<p>
Keyword search cannot provide NLP/IE functions, such as
stemming, synonyms, ranking, which are usually required by
search engine.
</p>
</li>

<li>Document limit

<ul class="org-ul">
<li>Field names cannot start with <code>$</code>, cannot contain <code>.</code>, cannot
contain <code>null</code>.
</li>

<li>Field value has a maximum index key length limit to be used as
index.
</li>

<li>Maximum document size is 16M. GridFS supports large file,
which is represented by a group of files that contain
different pieces of contents.
</li>

<li><code>_id</code> field may be any BSON data type except the array. It is
<code>ObjectId</code> by default.
</li>
</ul>
</li>

<li>DBRef

<p>
DBRefs are used to representing a document rather a specific
reference type. It contains the name of collection (optional:
database name).
</p>
</li>
</ul>
</div>
</div>
</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-02-14T00:00:00+01:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015-02-14-basic-mongodb-instructions.html" itemprop="url">Basic Mongodb Instructions</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Insert</a></li>
<li><a href="#sec-2">2. Find</a></li>
<li><a href="#sec-3">3. Select</a></li>
<li><a href="#sec-4">4. Update</a></li>
<li><a href="#sec-5">5. Remove</a></li>
<li><a href="#sec-6">6. Commands</a></li>
<li><a href="#sec-7">7. Query Cursor Methods</a></li>
<li><a href="#sec-8">8. MapReduce</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="xiaoliuai.github.io/blog/2015-02-14-basic-mongodb-instructions.html"><span class="section-number-2">1</span> Insert</a></h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.insert<span style="color: #657b83;">(</span>doc/docs<span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
You can insert one document or a list of documents.  When you
insert a list of documents, the operation is not atomic.  The
returned result shows the statistics of the write operations
including the write errors and the number of successfully inserted
documents.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Find</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.find<span style="color: #657b83;">(</span><span style="color: #2aa198;">{</span>name: value, <span style="color: #2aa198;">'name1.name2.name3'</span>:value/condition<span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57345;
</pre>
</div>
<p>
Check all the elements in array when &#8216;name#&#8217; corresponds to
array. Special conditions
</p>
<ul class="org-ul">
<li><code>$in, $ne, $nin, $lt, $gt, $lte, $gte</code>
</li>
<li><code>$and, $or, $not, $nor</code>
</li>
<li><code>$exists, $type</code>
</li>
<li><code>$regex, $text, $where, $mod</code>
</li>
<li><code>$all, $elemMatch, $size</code>
</li>
<li><code>$, $slice</code>
</li>
</ul>

<p>
Difference between with/without <code>$elemMatch</code> is that: <code>$elemMatch</code>
restrict that one element in array should match all the conditions,
while without <code>$elemMatch</code>, different elements in the array can
match different part of the conditions.
</p>

<p>
Match <b>element</b> / <b>array</b> can be done by query <code>{name: value}</code> when value
is a single <b>variable/object</b> or an <b>array</b>.
</p>

<p>
Elements in array can be retrieved by index
<code>db.COLLECTION.find({'name.0': value})</code>.
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Select</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>get attribute
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.find<span style="color: #657b83;">(</span>***, <span style="color: #2aa198;">{</span>name:1<span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
</li>
<li>get elements in array
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.find<span style="color: #657b83;">(</span>***, <span style="color: #2aa198;">{</span><span style="color: #2aa198;">'name1.name2'</span>:1<span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
This projection will returns all the elments with the path
&#8216;name1.name2&#8217; when any one in the path represents an array.
</p>

<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.find<span style="color: #657b83;">(</span>***, <span style="color: #2aa198;">{</span>name1: <span style="color: #b58900;">{</span>$elemMatch: <span style="color: #859900;">{</span>name2:value<span style="color: #859900;">}</span><span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
<code>$elemMatch</code> can be used in the second argument to limit the
returned elements in array. However, it <b>CANNOT</b> be used in nested
array and only returns the <b>FIRST</b> element.
</p>
</li>
<li>get elements in nested array.

<p>
<b>Aggregation framework/unwind.</b>
Aggregations are operations that process data records and return
computed results.
<b>Pipeline</b>
</p>

<p>
You can expand the nested arrays by several <code>$unwind</code>
operations to get a large number of documents that each one
contains a single combination of elements in different levels
of nested arrays. Then match the elements you need and maybe
regroup them together. However, if you want to aggregate the
matched elements in nested arrays into array after <code>$unwind</code>
operation, it is very complex.
</p>

<p>
However, you can just return the tasks by <code>$group</code> operation
that matches, for example, the nested element attributes.
</p>
</li>
</ul>
</div>
</div>



<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Update</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>update attribute:
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.update<span style="color: #657b83;">(</span>find condition, <span style="color: #2aa198;">{</span>$set: <span style="color: #b58900;">{</span>name: value<span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
<code>$inc</code> increase number, etc. <code>upsert</code> will insert element when it
does not exist in collection.
</p>
</li>
<li>update array:
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.update<span style="color: #657b83;">(</span>find condition, <span style="color: #2aa198;">{</span>$push/$pull: value<span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>

<div class="org-src-container">

<pre class="src src-javascript">db.students.update<span style="color: #657b83;">(</span>&#57344;&#57345;&#57345;
  <span style="color: #2aa198;">{</span> _id: 1 <span style="color: #2aa198;">}</span>,&#57344;&#57345;&#57345;
  <span style="color: #2aa198;">{</span>&#57344;&#57345;&#57345;
  $push: <span style="color: #b58900;">{</span>&#57344;&#57345;&#57345;
          scores: <span style="color: #859900;">{</span>&#57344;&#57345;&#57345;
             $each: <span style="color: #268bd2;">[</span> <span style="color: #657b83;">{</span> attempt: 3, score: 7 <span style="color: #657b83;">}</span>, <span style="color: #657b83;">{</span> attempt: 4, score: 4 <span style="color: #657b83;">}</span> <span style="color: #268bd2;">]</span>,&#57344;&#57345;
             $sort: <span style="color: #268bd2;">{</span> score: 1 <span style="color: #268bd2;">}</span>,&#57344;&#57345;&#57345;
             $slice: -3&#57344;&#57345;&#57345;
          <span style="color: #859900;">}</span>&#57344;&#57345;&#57345;
  <span style="color: #b58900;">}</span>&#57344;&#57345;&#57345;
&#57344;&#57345;&#57345;
<span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
The command above append 2 elements, then sort them by ascending
<i>score</i>, then keep the last 3 elements of the ordered array.
</p>
</li>
<li>update element in array:
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.update<span style="color: #657b83;">(</span><span style="color: #2aa198;">{</span><span style="color: #2aa198;">"name1.name2"</span>:value<span style="color: #2aa198;">}</span>, <span style="color: #2aa198;">{</span>$set:<span style="color: #b58900;">{</span><span style="color: #2aa198;">'name1.$.name2:value}})</span>&#57344;&#57345;
</pre>
</div>
<p>
It only works for one match.
</p>

<p>
If you want to update multiple elments, use forEach function.
</p>
<div class="org-src-container">

<pre class="src src-javascript">db.Projects.find<span style="color: #657b83;">()</span>.forEach<span style="color: #657b83;">(</span>&#57344;&#57345;&#57345;
    <span style="color: #859900;">function</span><span style="color: #2aa198;">(</span><span style="color: #6c71c4;">pj</span><span style="color: #2aa198;">){</span>&#57344;&#57345;&#57345;
        pj.groups.forEach<span style="color: #b58900;">(</span>&#57344;&#57345;&#57345;
            <span style="color: #859900;">function</span><span style="color: #859900;">(</span><span style="color: #6c71c4;">gp</span><span style="color: #859900;">){</span>&#57344;&#57345;&#57345;
                gp.tasks.forEach<span style="color: #268bd2;">(</span>&#57344;&#57345;&#57345;
                    <span style="color: #859900;">function</span><span style="color: #657b83;">(</span><span style="color: #6c71c4;">task</span><span style="color: #657b83;">){</span>&#57344;&#57345;&#57345;
                        <span style="color: #859900;">if</span> <span style="color: #2aa198;">(</span>task.name.match<span style="color: #b58900;">(</span><span style="color: #2aa198;">/update/</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">){</span>&#57344;&#57345;&#57345;
                            task.weight=5;&#57344;&#57345;&#57345;
                        <span style="color: #2aa198;">}</span>&#57344;&#57345;&#57345;
                    <span style="color: #657b83;">}</span><span style="color: #268bd2;">)</span>;&#57344;&#57345;&#57345;
            <span style="color: #859900;">}</span><span style="color: #b58900;">)</span>;&#57344;&#57345;&#57345;
        db.Projects.save<span style="color: #b58900;">(</span>pj<span style="color: #b58900;">)</span>;&#57344;&#57345;&#57345;
    <span style="color: #2aa198;">}</span>&#57344;&#57345;&#57345;
<span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
</li>
<li>update element in nested array.

<p>
<b>Impossible</b> for only one query. The issue is reported on 2010, but
is still there on 2015&#x2026;
</p>
</li>
</ul>

<p>
Functional key words:
</p>
<ul class="org-ul">
<li><code>$currentDate, $inc, $max, $min, $mul, $rename, $setOnInsert, $set, $unset</code>
</li>
<li><code>$, $addToSet, $pop, $pullAll, $pull, $pushAll, $push</code>
</li>
<li><code>$each, $position, $slice, $sort</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Remove</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>remove document
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.remove<span style="color: #657b83;">(</span>condition<span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
remove all documents when condition is not provided.
</p>
</li>
<li>remove colleciton
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.drop<span style="color: #657b83;">()</span>&#57344;&#57345;&#57345;
</pre>
</div>
</li>
<li>remove database
<div class="org-src-container">

<pre class="src src-javascript">use DATABASE&#57344;&#57345;&#57345;
db.dropDatabase<span style="color: #657b83;">()</span>&#57344;&#57345;&#57345;
</pre>
</div>
</li>
<li>remove attribute
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.update<span style="color: #657b83;">(</span>find, <span style="color: #2aa198;">{</span>$unset: <span style="color: #b58900;">{</span>name: value<span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
value can be 1, &#8220;&#8221;, true/false.
</p>
</li>
<li>remove element in array
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.update<span style="color: #657b83;">(</span><span style="color: #2aa198;">{</span><span style="color: #2aa198;">"name1.name2"</span>:value<span style="color: #2aa198;">}</span>, <span style="color: #2aa198;">{</span>$unset:<span style="color: #b58900;">{</span><span style="color: #2aa198;">'name1.$.name2'</span>:1<span style="color: #b58900;">}</span><span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Commands</h2>
<div class="outline-text-2" id="text-6">
<p>
<code>show dbs</code>
<code>use DB</code>
<code>show collection</code>
<code>help</code>
<code>db.help()</code>
<code>db.COLLECTION.help()</code>
</p>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Query Cursor Methods</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li><code>count()</code> // count of documents returned in a curcor
</li>
<li><code>explain()</code> // report
</li>
<li><code>hint()</code> // Forces MongoDB to use a specific index for a query
</li>
<li><code>limit()</code> // constraints size of returned results
</li>
<li><code>skip()</code> // skip the first number of documents
</li>
<li><code>sort()</code>
</li>
<li><code>toArray()</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> MapReduce</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-javascript">db.COLLECTION.mapReduce<span style="color: #657b83;">(</span>mapFunction,&#57344;&#57345;&#57345;
                        reduceFunction,&#57344;&#57345;&#57345;
                        <span style="color: #2aa198;">{</span>&#57344;&#57345;&#57345;
                            query: <span style="color: #2aa198;">"query performed at the beginning"</span>,&#57345;
                            out: <span style="color: #2aa198;">"out collection name"</span>,&#57344;&#57345;&#57345;
                            finalize: finalizeFunction&#57344;&#57345;&#57345;
                        <span style="color: #2aa198;">}</span><span style="color: #657b83;">)</span>&#57344;&#57345;&#57345;
</pre>
</div>
<p>
Query -&gt; map -&gt; reduce -&gt; finalize -&gt; out.
</p>
<ul class="org-ul">
<li>The <i>reduce</i> function muse return object with the same type of the output
of the <i>map</i> function.
</li>
<li>The order of emited elements should not affect the output of
reduce function.
</li>
<li>The reduce function must be <i>Idempotent</i>, which means
<i>f(f(x))=f(x)</i>.
</li>
</ul>
</div>
</div>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/posts/2">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next disabled"><a href="#">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3">
      
        <section>
  <div class="panel-heading">
    <h3 class="panel-title">About Me</h3>
        </div>
        <div class="list-group">
        <p class="list-group-item" style="text-align: center; max-height: 400px">
                <img src="/images/Me.png" height=150 width=Auto>
        </p>
        <p class="list-group-item">穷苦的科研狗一只</p>
        <p class="list-group-item"></p>
        </div>
</section>
<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/2015-12-10-summary-and-task-list.html">Summary and Task List</a>
    
    <a class="list-group-item " href="/blog/2015-03-13-akka.html">Akka</a>
    
    <a class="list-group-item " href="/blog/2015-03-04-spring-tutorial.html">Spring Tutorial</a>
    
    <a class="list-group-item " href="/blog/2015-03-04-spring-guide-examples.html">Spring Guide Examples</a>
    
    <a class="list-group-item " href="/blog/2015-02-28-start-maven-example.html">Start Maven Example</a>
    
  </div>
</section>
<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Categories</h3>
  </div>
  <div class="list-group">
    
    
    <a class="list-group-item " href="/blog/categories/geek/index.html">
        <span class="badge">2</span>
        geek
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/parallelism/index.html">
        <span class="badge">1</span>
        parallelism
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/web/index.html">
        <span class="badge">7</span>
        web
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/database/index.html">
        <span class="badge">2</span>
        database
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/language/index.html">
        <span class="badge">3</span>
        language
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/management/index.html">
        <span class="badge">2</span>
        management
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/jushan/index.html">
        <span class="badge">1</span>
        jushan
      </a>
    
  </div>
</section>
<section class="panel panel-default">
    <div class="panel-heading">
            <h2 class="panel-title">标签列表</h2>
    </div>
    <ul class="list-group">
        <li class="tag-cloud list-group-item">
                <a style="font-size: 200%" href="/tags/maven/">maven<sup>4</sup></a>
<a style="font-size: 173%" href="/tags/spring/">Spring<sup>3</sup></a>
<a style="font-size: 173%" href="/tags/java/">Java<sup>3</sup></a>
<a style="font-size: 173%" href="/tags/scala/">Scala<sup>3</sup></a>
<a style="font-size: 135%" href="/tags/mongodb/">Mongodb<sup>2</sup></a>
<a style="font-size: 135%" href="/tags/angularjs/">AngularJS<sup>2</sup></a>
<a style="font-size: 135%" href="/tags/github/">GitHub<sup>2</sup></a>
<a style="font-size: 135%" href="/tags/org-mode/">Org-mode<sup>2</sup></a>
<a style="font-size: 70%" href="/tags/javascript/">JavaScript<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/octave/">Octave<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/matlab/">Matlab<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/nodejs/">NodeJS<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/bower/">bower<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/yoeman/">yoeman<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/gulp/">gulp<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/mpi/">MPI<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/octopress/">Octopress<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/jekyll/">Jekyll<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/maven/">Maven<sup>1</sup></a>
<a style="font-size: 70%" href="/tags/jushan/">Jushan<sup>1</sup></a>

        </li>
    </ul>
    <!-- <div class="list-group">
        <ul class="tag-cloud">
                <a style="font-size: 200%" href="/tags/maven/">maven<sup>4</sup></a>
<a style="font-size: 169%" href="/tags/spring/">Spring<sup>3</sup></a>
<a style="font-size: 169%" href="/tags/java/">Java<sup>3</sup></a>
<a style="font-size: 169%" href="/tags/scala/">Scala<sup>3</sup></a>
<a style="font-size: 125%" href="/tags/mongodb/">Mongodb<sup>2</sup></a>
<a style="font-size: 125%" href="/tags/angularjs/">AngularJS<sup>2</sup></a>
<a style="font-size: 125%" href="/tags/github/">GitHub<sup>2</sup></a>
<a style="font-size: 125%" href="/tags/org-mode/">Org-mode<sup>2</sup></a>
<a style="font-size: 50%" href="/tags/javascript/">JavaScript<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/octave/">Octave<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/matlab/">Matlab<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/nodejs/">NodeJS<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/bower/">bower<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/yoeman/">yoeman<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/gulp/">gulp<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/mpi/">MPI<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/octopress/">Octopress<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/jekyll/">Jekyll<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/maven/">Maven<sup>1</sup></a>
<a style="font-size: 50%" href="/tags/jushan/">Jushan<sup>1</sup></a>

        </ul>
    </div> &#8211;>
</section>

<section class="panel panel-default clearfix">
  <div class="panel-heading">
      <h3 class="panel-title">GitHub Repos</h3>
  </div>
  <div class="list-group" id="gh_repos">
    <p class="loading">Status updating&#8230;</p>
  </div>
  
    <div class="gh-profile-link pull-right text-muted">
      <a href="https://github.com/xiaoliuai">@xiaoliuai</a> on GitHub
    </div>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'xiaoliuai',
            count: 2,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2015 - Xiao Liu<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
