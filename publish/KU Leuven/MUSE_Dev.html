<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Parallelism&#xa0;&#xa0;&#xa0;<span class="tag"><span class="blog">blog</span></span></a>
<ul>
<li><a href="#sec-1-1">Installation</a>
<ul>
<li><a href="#sec-1-1-1">Local Machine</a></li>
<li><a href="#sec-1-1-2">Virtual Machine</a></li>
</ul>
</li>
<li><a href="#sec-1-2">Ocatve</a></li>
<li><a href="#sec-1-3">C</a></li>
<li><a href="#sec-1-4">Performance Comparison</a></li>
</ul>
</li>
<li><a href="#sec-2">Results</a>
<ul>
<li><a href="#sec-2-1">Running time and CPU charges of octave, matlab, mpi.</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Parallelism&#xa0;&#xa0;&#xa0;<span class="tag"><span class="blog">blog</span></span></h2>
<div class="outline-text-2" id="text-1">
<p>
In this article, I will introduce the installation and basic use of MPI
framework through octave. Matlab is widely used in many scientific
domains as it enables the developers focus on the algorithms other
than programming skills. However, the support of parallelism computing
from Matlab is limited and expensive, especially for computing on
clusters. Currently, two parallelism frameworks are widely used: MPI
(Message Passage Interface) and MapReduce. Hadoop, which is an Java
implementation of MapReduce, does not currently support Matlab or
Octave. Therefore, I choose the MPI + Octave as a parallelism solution
for Matlab users.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Installation</h3>
<div class="outline-text-3" id="text-1-1">
</div><div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1">Local Machine</h4>
<div class="outline-text-4" id="text-1-1-1">
<ul class="org-ul">
<li>Install open-mpi.
<ul class="org-ul">
<li>On Mac OS X with homebrew, <code>brew install open-mpi</code>
</li>
<li>On Ubuntu, the direct way is install the packages via package
manager <code>sudo apt-get install openmpi-bin openmpi-common
        openmpi-checkpoint libopenmpi-dev libopenmpi-X.X</code>. However,
the OpenMPI installed through this method does not work with
the octave-mpi package due to a library linkage problem. A
fast cue is compiling and installing it manually.
Download the openmpi package <a href="http://www.open-mpi.org/software/ompi/v1.8/">openmpi-1.8.3.tar.gz</a>.
<div class="org-src-container">

<pre class="src src-bash">tar xzvf openmpi-1.8.3.tar.gz
cd openmpi-1.8.3
./configure --dsiable-dlopen
make
sudo make install
</pre>
</div>
</li>
</ul>
</li>
<li>Install octave
<ul class="org-ul">
<li>On Mac OS X with homebrew
<ol class="org-ol">
<li>install XQuartz from image file downloaded from <a href="http://xquartz.macosforge.org/landing/">http://xquartz.macosforge.org/landing/</a>.
</li>
<li><code>brew tap homebrew/science</code>
</li>
<li>install gfortran <code>brew install gcc</code>
</li>
<li><code>brew install octave</code>
</li>
</ol>
</li>
<li>On Ubuntu
<code>sudo apt-get install octave</code>
</li>
</ul>
</li>
<li>Install octave mpi package
<ul class="org-ul">
<li>Inside octave
<div class="org-src-container">

<pre class="src src-octave">putenv (<span style="color: #2aa198;">"PATH"</span><span style="color: #6c71c4;">,</span> [<span style="color: #2aa198;">"path/to/mpic++/:"</span> getenv(<span style="color: #2aa198;">"PATH"</span>)]) <span style="color: #93a1a1; font-style: italic;">% optional</span>
pkg install <span style="color: #6c71c4;">-</span>forge mpi      <span style="color: #93a1a1; font-style: italic;">% install mpi from internet or</span>
pkg install PATH<span style="color: #6c71c4;">/</span>TO<span style="color: #6c71c4;">/</span>PACKAGE <span style="color: #93a1a1; font-style: italic;">% install mpi from downloaded package</span>
</pre>
</div>
</li>
<li>Through package manager in Ubuntu (deprecated), run <code>apt-get
        install octave-openmpi-ext</code>. As the pakcage manager could
automatically install the OpenMPI package, which does not work
with the octave-mpi actually, we suggest do NOT use this
method.
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-1-2" class="outline-4">
<h4 id="sec-1-1-2">Virtual Machine</h4>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">Ocatve</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Run octave code with mpi.
<ul class="org-ul">
<li>First way is run code from shell/terminal/ssh.
<div class="org-src-container">

<pre class="src src-bash">mpirun [OPTIONS] octave -q --eval '[octave code, function or script name]'
</pre>
</div>
</li>
<li>Second way is call the system command inside octave.
<div class="org-src-container">

<pre class="src src-octave">system (<span style="color: #2aa198;">"mpirun octave -q --eval '[octave code, function or script name]"</span>)<span style="color: #6c71c4;">;</span>
</pre>
</div>
</li>
<li>Octave mpi package contains some simple examples to show you
how to write the octave code that enables the parallelism via
MPI. These codes are in two possible locations if you install
the octave mpi package globally:
<ul class="org-ul">
<li><code>/usr/share/doc/octave-mpi/examples/</code>
</li>
<li><code>/usr/share/octave/packages/mpi-1.2.0/</code>
</li>
</ul>
<p>
If you install the package under user's home folder, you can
find exmaple codes under <code>$HOME/octave/packages/mpi-1.2.0/</code>. To
test the example inside octave, run command
<code>[info res] = system ("mpirun octave -q --eval 'pkg load mpi; helloworld
       ()'");</code>. <b>The displayed string of the funciton, e.g. <code>helloworld()</code>, will return by this invokation. Therefore your can embed it in another
serial computing octave script context (use str2num()).</b>
</p>
</li>
<li>Frequently used mpirun options: <code>--hostfile</code> indicate the file
that contains the hostnames of cluster; <code>-np</code> number of
processes to run.
</li>
</ul>
</li>

<li>The interface provided by octave mpi package is a subset of all
MPI functions. How to parallelize the code?
Example 1, basic example about initializing the environment, send
and receive messages/variables. Basically, these functions are
enough to create the parallelism program.
<div class="org-src-container">

<pre class="src src-octave">MPI_Init()<span style="color: #6c71c4;">;</span>
communicator <span style="color: #6c71c4;">=</span> MPI_Comm_Load(<span style="color: #2aa198;">"a label string"</span>) <span style="color: #93a1a1; font-style: italic;">% one can use multiple communicators indicated by different label</span>
my_rank <span style="color: #6c71c4;">=</span> MPI_Comm_rank(communicator) <span style="color: #93a1a1; font-style: italic;">% rank is the indicator(id) of current process</span>
p <span style="color: #6c71c4;">=</span> MPI_Comm_size(CW) <span style="color: #93a1a1; font-style: italic;">% the size of a communicator is the number of processes handled by the communicator</span>
[info] <span style="color: #6c71c4;">=</span> MPI_Send(value<span style="color: #6c71c4;">,</span> ranks<span style="color: #6c71c4;">,</span> TAG<span style="color: #6c71c4;">,</span> communicator)<span style="color: #6c71c4;">;</span>
<span style="color: #93a1a1; font-style: italic;">% </span><span style="color: #93a1a1; font-style: italic;">value:  a octave variable</span>
<span style="color: #93a1a1; font-style: italic;">% </span><span style="color: #93a1a1; font-style: italic;">ranks:  a vector that contains the id of destination processes, can be an integer</span>
<span style="color: #93a1a1; font-style: italic;">% </span><span style="color: #93a1a1; font-style: italic;">TAG:    an integer to identify the message (when there are many messages sent in the same context)</span>
<span style="color: #93a1a1; font-style: italic;">% </span><span style="color: #93a1a1; font-style: italic;">info:   an integer that indicates the success of failure state of process</span>
[value<span style="color: #6c71c4;">,</span> info] <span style="color: #6c71c4;">=</span> MPI_Recv(source<span style="color: #6c71c4;">,</span> TAG<span style="color: #6c71c4;">,</span> communicator)
<span style="color: #93a1a1; font-style: italic;">% </span><span style="color: #93a1a1; font-style: italic;">source: the id the process that send this message</span>
<span style="color: #93a1a1; font-style: italic;">%         </span><span style="color: #93a1a1; font-style: italic;">receive from any process if source is -1</span>
<span style="color: #93a1a1; font-style: italic;">%         </span><span style="color: #93a1a1; font-style: italic;">process starts from 0 and process 0 is usually used as master process</span>
<span style="color: #93a1a1; font-style: italic;">% </span><span style="color: #93a1a1; font-style: italic;">value:  received variable</span>
MPI_Finalize()
</pre>
</div>

<p>
Process sequence control functions:
</p>
<ul class="org-ul">
<li>Function <code>MPI_Barrier(communicator)</code> will block the process until
all the processes reached this location.
</li>

<li>Function <code>MPI_Probe(RANK, TAG, COMM)</code> test if process [RANK] send
a message with TAG from communicator COMM. Block the process if
no message arrive.
</li>

<li>Function <code>MPI_Iprobe(RANK, TAG, COMM)</code> test if process [RANK] send
a message with TAG from communicator COMM. NOT block the process
if no message arrive.
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">C</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>Point-to-point communication
<ul class="org-ul">
<li>blocked
</li>
<li>non-blocked
</li>
</ul>
</li>
<li>Collective communication
<ul class="org-ul">
<li>MPI_Reduce
</li>
<li>MPI_Scatter
</li>
</ul>
</li>
<li>Derived data type
</li>
<li>Group and communicator management
</li>
<li>Virtual topology routine
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">Performance Comparison</h3>
<div class="outline-text-3" id="text-1-4">
<p>
<iframe
src="https://docs.google.com/spreadsheets/d/1kOLf_azmw872VHm6lmOxsPUvpD0hs-ZvbPUJDOjMBFM/pubhtml?gid=0&amp;single=true&amp;widget=true&amp;headers=false"
width="900" height="600"></iframe>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Results</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Running time and CPU charges of octave, matlab, mpi.</h3>
<div class="outline-text-3" id="text-2-1">
<p>
On muse.cs.kuleuven.be, which is a server that contains 2 CPUs, each
CPU contains 6 real cores ~ 12 logical cores.
Two "for" loops to apply each element of the matrix multiplication one
by one.
Each configuration is run 10 times to get an average running time.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">octave matrix</th>
<th scope="col" class="left">octave for</th>
<th scope="col" class="left">matlab matrix</th>
<th scope="col" class="left">matlab for</th>
<th scope="col" class="left">matlab parfor</th>
<th scope="col" class="left">octave mpi 4</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">time</td>
<td class="left">0.17s</td>
<td class="left">23.5s</td>
<td class="left">0.036s</td>
<td class="left">10.9s</td>
<td class="left">4.77s</td>
<td class="left">6.18s</td>
</tr>

<tr>
<td class="left">cpu charge</td>
<td class="left">one core</td>
<td class="left">one core</td>
<td class="left">&gt; 200%</td>
<td class="left">one core</td>
<td class="left">4 cores</td>
<td class="left">4 cores</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">time</td>
<td class="left">20.1s</td>
<td class="left">-/-</td>
<td class="left">2.11s</td>
<td class="left">-/-</td>
<td class="left">-/-</td>
<td class="left">-/-</td>
</tr>

<tr>
<td class="left">cpu charge</td>
<td class="left">&lt;= 200%</td>
<td class="left">-/-</td>
<td class="left">&gt;800%</td>
<td class="left">-/-</td>
<td class="left">-/-</td>
<td class="left">-/-</td>
</tr>
</tbody>
</table>

<p>
MPI octave configuration tests
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="left">set worker</td>
<td class="right">4</td>
<td class="right">8</td>
<td class="right">11</td>
<td class="right">12</td>
<td class="right">24</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">real worker</td>
<td class="right">4</td>
<td class="right">8</td>
<td class="right">11</td>
<td class="right">12</td>
<td class="right">24</td>
</tr>

<tr>
<td class="left">1000*1000 matrix</td>
<td class="left">time</td>
<td class="right">6.29</td>
<td class="right">3.25</td>
<td class="right">3.34</td>
<td class="right">4.16</td>
<td class="right">2.00</td>
</tr>
</tbody>
</table>

<p>
Matlab configuration tests
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="left">set worker</td>
<td class="right">4</td>
<td class="right">8</td>
<td class="right">11</td>
<td class="right">12</td>
<td class="right">(run only one time)   24</td>
</tr>

<tr>
<td class="left">real worker</td>
<td class="right">4</td>
<td class="right">8</td>
<td class="right">11</td>
<td class="right">12</td>
<td class="right">12</td>
</tr>

<tr>
<td class="left">time</td>
<td class="right">4.38</td>
<td class="right">2.37</td>
<td class="right">1.90</td>
<td class="right">1.84</td>
<td class="right">15.81</td>
</tr>
</tbody>
</table>


<p>
One for loop layer, replace the inner for loops by vector operation
MPI octave:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">set worker</th>
<th scope="col" class="right">4</th>
<th scope="col" class="right">8</th>
<th scope="col" class="right">11</th>
<th scope="col" class="right">12</th>
<th scope="col" class="right">24</th>
</tr>

<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">real worker</th>
<th scope="col" class="right">4</th>
<th scope="col" class="right">8</th>
<th scope="col" class="right">11</th>
<th scope="col" class="right">12</th>
<th scope="col" class="right">24</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">1000*1000 matrix</td>
<td class="left">time</td>
<td class="right">0.247</td>
<td class="right">0.188</td>
<td class="right">0.195</td>
<td class="right">0.197</td>
<td class="right">0.310</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">5000*5000 matrix</td>
<td class="left">time</td>
<td class="right">28.0</td>
<td class="right">17.7</td>
<td class="right">17.8</td>
<td class="right">18.9</td>
<td class="right">20.5</td>
</tr>
</tbody>
</table>
<p>
Matlab:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">set worker</th>
<th scope="col" class="right">4</th>
<th scope="col" class="right">8</th>
<th scope="col" class="right">11</th>
<th scope="col" class="right">12</th>
<th scope="col" class="right">24</th>
</tr>

<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">real worker</th>
<th scope="col" class="right">4</th>
<th scope="col" class="right">8</th>
<th scope="col" class="right">11</th>
<th scope="col" class="right">12</th>
<th scope="col" class="right">12</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">1000*1000 matrix</td>
<td class="left">time</td>
<td class="right">0.286</td>
<td class="right">0.277</td>
<td class="right">0.263</td>
<td class="right">0.268</td>
<td class="right">14.6</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">5000*5000 matrix</td>
<td class="left">time</td>
<td class="right">27.6</td>
<td class="right">16.0</td>
<td class="right">15.0</td>
<td class="right">15.5</td>
<td class="right">34.5</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
